from distutils.core import setup
from distutils.extension import Extension
import os
import os.path
import glob

try:
  destdir = os.environ["DESTDIR"]
except KeyError:
  destdir = ""

prefix = None
import sys
for i, arg in enumerate(sys.argv):
  if "--prefix" in arg:
    prefix = arg.split('=')[1]
    break

# Get all the plugin directories we have
plugin_dirs = [dir for dir in os.listdir('plugins') if os.path.isdir(os.path.join('plugins', dir)) and dir[0] != '.']
plugin_data_files = []
for plugin in plugin_dirs:
  if prefix is None:
    plugin_data_files.append((destdir + "@prefix@/share/diamond/plugins/" + plugin,
      glob.glob('plugins/' + plugin + '/*.py')))
  else:
    plugin_data_files.append((destdir + "/" + prefix + "/share/diamond/plugins/" + plugin,
      glob.glob('plugins/' + plugin + '/*.py')))

# Consider whether we honour the configure or the setup prefix
gui_data_files = []
if prefix is None:
  gui_data_files.append((destdir + "@prefix@/share/diamond/gui",
    ["gui/gui.glade", "gui/diamond.svg"]))
else:
  gui_data_files.append((destdir + "/" + prefix + "/share/diamond/gui",
    ["gui/gui.glade", "gui/diamond.svg"]))

setup(
      name='diamond',
      version='1.0',
      description="Fluidity preprocessor",
      author = "The ICOM team",
      author_email = "patrick.farrell@imperial.ac.uk",
      url = "http://amcg.ese.ic.ac.uk",
      packages = ['diamond'],
      package_dir = {'diamond': 'diamond'},
      scripts=["bin/diamond"],
      data_files = gui_data_files + plugin_data_files
     )

