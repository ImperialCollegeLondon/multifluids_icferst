<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ICFERST: solvers_module Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="IC_FERST_Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ICFERST
   &#160;<span id="projectnumber">22_06</span>
   </div>
   <div id="projectbrief">Reservoir simulator based on DCVFEM, Dynamic Mesh optimisation and Surface-based modelling</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('namespacesolvers__module.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">solvers_module Module Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>All the subroutines associated to solving non-linear systems, Schur complement, etc.  
<a href="namespacesolvers__module.html#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:adef72e22883fb36304a2da0099927175"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacesolvers__module.html#adef72e22883fb36304a2da0099927175">boundedsolutioncorrections</a> (state, packed_state, Mdims, CV_funs, small_findrm, small_colm, Field_name, for_sat, min_max_limits)</td></tr>
<tr class="memdesc:adef72e22883fb36304a2da0099927175"><td class="mdescLeft">&#160;</td><td class="mdescRight">The sparcity of the local CV connectivity is in: small_findrm, small_colm. ngl_its=max no of global iterations e.g. 100. error_tol = tolerance on the iterations.  <a href="namespacesolvers__module.html#adef72e22883fb36304a2da0099927175">More...</a><br /></td></tr>
<tr class="separator:adef72e22883fb36304a2da0099927175"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4773b0f364c52ef1ca48a3ead9f6693c"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacesolvers__module.html#a4773b0f364c52ef1ca48a3ead9f6693c">fpi_backtracking</a> (nphase, Mdims, ndgln, state, packed_state, sat_bak, backtrack_sat, backtrack_par_from_schema, Previous_convergence, satisfactory_convergence, new_backtrack_par, Max_sat_its, its, nonlinear_iteration, useful_sats, res, res_ratio, first_res)</td></tr>
<tr class="memdesc:a4773b0f364c52ef1ca48a3ead9f6693c"><td class="mdescLeft">&#160;</td><td class="mdescRight">:In this subroutine we applied some corrections and backtrack_par on the saturations obtained from the saturation equation this subroutine is detailed in Salinas et al. 2017 doi:10.1002/fld.4357 The method ensures convergence "independent" of the time step.  <a href="namespacesolvers__module.html#a4773b0f364c52ef1ca48a3ead9f6693c">More...</a><br /></td></tr>
<tr class="separator:a4773b0f364c52ef1ca48a3ead9f6693c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9bba1ef1495c1a4a47a7eea3f2c17719"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacesolvers__module.html#a9bba1ef1495c1a4a47a7eea3f2c17719">set_saturation_to_sum_one</a> (mdims, packed_state, state, do_not_update_halos)</td></tr>
<tr class="memdesc:a9bba1ef1495c1a4a47a7eea3f2c17719"><td class="mdescLeft">&#160;</td><td class="mdescRight">:This subroutines eliminates the oscillations in the saturation that are bigger than a certain tolerance and also sets the saturation to be between bounds  <a href="namespacesolvers__module.html#a9bba1ef1495c1a4a47a7eea3f2c17719">More...</a><br /></td></tr>
<tr class="separator:a9bba1ef1495c1a4a47a7eea3f2c17719"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a27f681607a9e40b1e99a8f45cd6a940c"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacesolvers__module.html#a27f681607a9e40b1e99a8f45cd6a940c">non_porous_ensure_sum_to_one</a> (Mdims, packed_state, do_not_update_halos)</td></tr>
<tr class="memdesc:a27f681607a9e40b1e99a8f45cd6a940c"><td class="mdescLeft">&#160;</td><td class="mdescRight">: This subroutines eliminates the oscillations in the saturation that are bigger than a certain tolerance and also sets the saturation to be between bounds  <a href="namespacesolvers__module.html#a27f681607a9e40b1e99a8f45cd6a940c">More...</a><br /></td></tr>
<tr class="separator:a27f681607a9e40b1e99a8f45cd6a940c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a85646e595797edceed6d3be72173ef7f"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacesolvers__module.html#a85646e595797edceed6d3be72173ef7f">initialise_saturation_sums_one</a> (mdims, packed_state, find_scapegoat_phase)</td></tr>
<tr class="memdesc:a85646e595797edceed6d3be72173ef7f"><td class="mdescLeft">&#160;</td><td class="mdescRight">:Ensure that the saturations at the beginning sum to one, if they do not all the error is compensated in the scapegoat_phase. Normally the last  <a href="namespacesolvers__module.html#a85646e595797edceed6d3be72173ef7f">More...</a><br /></td></tr>
<tr class="separator:a85646e595797edceed6d3be72173ef7f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4e86e8d68a22dcc9e670af385d938bf4"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacesolvers__module.html#a4e86e8d68a22dcc9e670af385d938bf4">auto_backtracking</a> (Mdims, backtrack_par_factor, courant_number_in, first_time_step, nonlinear_iteration, I_am_temperature)</td></tr>
<tr class="memdesc:a4e86e8d68a22dcc9e670af385d938bf4"><td class="mdescLeft">&#160;</td><td class="mdescRight">: The maximum backtracking factor is calculated based on the Courant number and physical effects ocurring in the domain  <a href="namespacesolvers__module.html#a4e86e8d68a22dcc9e670af385d938bf4">More...</a><br /></td></tr>
<tr class="separator:a4e86e8d68a22dcc9e670af385d938bf4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a119325e40cdcd54b1766472b55920364"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacesolvers__module.html#a119325e40cdcd54b1766472b55920364">get_anderson_acceleration_new_guess</a> (N, M, NewField, History_field, stored_residuals, max_its, prev_small_matrix, restart_now)</td></tr>
<tr class="memdesc:a119325e40cdcd54b1766472b55920364"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine provides a new guess based on previous updates and residuals. Use this subroutine to speed up any system being solved by looping. A new guess is computed and returned Method explained in DOI.10.1137/10078356X.  <a href="namespacesolvers__module.html#a119325e40cdcd54b1766472b55920364">More...</a><br /></td></tr>
<tr class="separator:a119325e40cdcd54b1766472b55920364"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af233b921efdba4e01b5920ccf509ef29"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacesolvers__module.html#af233b921efdba4e01b5920ccf509ef29">scale_petsc_matrix</a> (Mat_petsc)</td></tr>
<tr class="memdesc:af233b921efdba4e01b5920ccf509ef29"><td class="mdescLeft">&#160;</td><td class="mdescRight">In this subroutine the matrix is re-scaled based on the formula D^-0.5 * A * D^-0.5 X'= D^-0.5 b; and next X = D^-0.5 * X'; IMPORTANT: the step X = D^-0.5 * X' needs to be done elsewhere store the diagonal before calling this This should allow to deal with high ranges of viscosity ratio for example A is-written.  <a href="namespacesolvers__module.html#af233b921efdba4e01b5920ccf509ef29">More...</a><br /></td></tr>
<tr class="separator:af233b921efdba4e01b5920ccf509ef29"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a76231fdbfc56035f797b1c21675c02ed"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacesolvers__module.html#a76231fdbfc56035f797b1c21675c02ed">duplicate_petsc_matrix</a> (MAT_A, MAT_B)</td></tr>
<tr class="separator:a76231fdbfc56035f797b1c21675c02ed"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab1b067219293fc4e2583394acce02bfa"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacesolvers__module.html#ab1b067219293fc4e2583394acce02bfa">petsc_stokes_solver</a> (packed_state, Mdims, Mmat, ndgln, Mspars, final_phase, pmat, P_all, deltaP, rhs_p, solver_option_path, Dmat)</td></tr>
<tr class="memdesc:ab1b067219293fc4e2583394acce02bfa"><td class="mdescLeft">&#160;</td><td class="mdescRight">In this subroutine the Schur complement is generated and solved using PETSc to update the pressure field Matrices need to be in petsc format and pmat is the preconditioned matrix, i.e. pmat = A11- A10(AproxA00^-1)A01.  <a href="namespacesolvers__module.html#ab1b067219293fc4e2583394acce02bfa">More...</a><br /></td></tr>
<tr class="separator:ab1b067219293fc4e2583394acce02bfa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aad076a468a68cdb44f63a6290e9c8159"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacesolvers__module.html#aad076a468a68cdb44f63a6290e9c8159">convert_c_and_ct_mat_to_petsc_format</a> (packed_state, Mdims, Mmat, ndgln, Mspars, NPHASE)</td></tr>
<tr class="memdesc:aad076a468a68cdb44f63a6290e9c8159"><td class="mdescLeft">&#160;</td><td class="mdescRight">: This subroutine converts the C (gradient) and CT (Divergence) matrices into PETSc format Mainly devoted to be used by the PETSc stokes schur solver This can be used when moving from the ICFERST matrix format to PETSc as reference  <a href="namespacesolvers__module.html#aad076a468a68cdb44f63a6290e9c8159">More...</a><br /></td></tr>
<tr class="separator:aad076a468a68cdb44f63a6290e9c8159"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>All the subroutines associated to solving non-linear systems, Schur complement, etc. </p>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a4e86e8d68a22dcc9e670af385d938bf4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4e86e8d68a22dcc9e670af385d938bf4">&#9670;&nbsp;</a></span>auto_backtracking()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public solvers_module::auto_backtracking </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__dimensions.html">multi_dimensions</a>), intent(in)&#160;</td>
          <td class="paramname"><em>Mdims</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(inout)&#160;</td>
          <td class="paramname"><em>backtrack_par_factor</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(inout)&#160;</td>
          <td class="paramname"><em>courant_number_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>first_time_step</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nonlinear_iteration</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>I_am_temperature</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>: The maximum backtracking factor is calculated based on the Courant number and physical effects ocurring in the domain </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Mdims</td><td>Data type storing all the dimensions describing the mesh, fields, nodes, etc </td></tr>
    <tr><td class="paramname">backtrack_par_factor</td><td>INOUT backtracking value to use </td></tr>
    <tr><td class="paramname">courant_number_in</td><td>Courant number and shock front courant number </td></tr>
    <tr><td class="paramname">first_time_step</td><td>true if the first one </td></tr>
    <tr><td class="paramname">nonlinear_iteration</td><td>current non-linear iteration </td></tr>
    <tr><td class="paramname">I_am_temperature</td><td>If doing temperature true (DEPRECATED PROBABLY) </td></tr>
  </table>
  </dd>
</dl>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_a4e86e8d68a22dcc9e670af385d938bf4_icgraph.png" border="0" usemap="#namespacesolvers__module_a4e86e8d68a22dcc9e670af385d938bf4_icgraph" alt=""/></div>
<map name="namespacesolvers__module_a4e86e8d68a22dcc9e670af385d938bf4_icgraph" id="namespacesolvers__module_a4e86e8d68a22dcc9e670af385d938bf4_icgraph">
<area shape="rect" title=": The maximum backtracking factor is calculated based on the Courant number and physical effects ocur..." alt="" coords="756,5,919,47"/>
<area shape="rect" href="namespacemultiphase__1d__engine.html#ad29606c63b241238edd97827aa4564d7" title="Calls to generate the transport equation for the saturation. Embeded an FPI with backtracking method ..." alt="" coords="467,5,708,47"/>
<area shape="rect" href="namespacemultiphase__time__loop.html#a04598d33bda1f46f9537570dbc0119bc" title="This is the main subroutine from which everything is called. It performs the time&#45;loop and therefore ..." alt="" coords="219,5,419,47"/>
<area shape="rect" href="_multiphase___prototype___wrapper_8_f90.html#a0849c5f8b4a25b1987221c6a5a69eeda" title=" " alt="" coords="5,5,171,47"/>
</map>
</div>

</div>
</div>
<a id="adef72e22883fb36304a2da0099927175"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adef72e22883fb36304a2da0099927175">&#9670;&nbsp;</a></span>boundedsolutioncorrections()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public solvers_module::boundedsolutioncorrections </td>
          <td>(</td>
          <td class="paramtype">type( state_type ), dimension( : ), intent(inout)&#160;</td>
          <td class="paramname"><em>state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type( state_type ), intent(inout)&#160;</td>
          <td class="paramname"><em>packed_state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__dimensions.html">multi_dimensions</a>), intent(in)&#160;</td>
          <td class="paramname"><em>Mdims</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__shape__funs.html">multi_shape_funs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CV_funs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension( : ), intent(in)&#160;</td>
          <td class="paramname"><em>small_findrm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension( : ), intent(in)&#160;</td>
          <td class="paramname"><em>small_colm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">character( len=* ), intent(in)&#160;</td>
          <td class="paramname"><em>Field_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>for_sat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(2), optional&#160;</td>
          <td class="paramname"><em>min_max_limits</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The sparcity of the local CV connectivity is in: small_findrm, small_colm. ngl_its=max no of global iterations e.g. 100. error_tol = tolerance on the iterations. </p>
<p>nloc_its: This iteration is very good at avoiding spreading the modifications too far - however it can stagnate. nloc_its2: This iteration is very good at avoiding stagnating but does spread the modifcations far. us a single iteration because of this as default... nits_nod: iterations at a nod - this iteration is very good at avoiding spreading the modifications too far - however it can stagnate. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">state</td><td>Linked list containing all the fields defined in diamond and considered by Fluidity </td></tr>
    <tr><td class="paramname">packed_state</td><td>Linked list containing all the fields used by IC-FERST, memory partially shared with state </td></tr>
    <tr><td class="paramname">Mdims</td><td>Data type storing all the dimensions describing the mesh, fields, nodes, etc </td></tr>
    <tr><td class="paramname">CV_funs</td><td>Shape functions for the CV mesh </td></tr>
    <tr><td class="paramname">small_findrm</td><td>sparcity of the local CV connectivity is in: small_findrm, small_colm. </td></tr>
    <tr><td class="paramname">small_colm</td><td>sparcity of the local CV connectivity is in: small_findrm, small_colm. </td></tr>
    <tr><td class="paramname">Field_name</td><td>Name of the field </td></tr>
    <tr><td class="paramname">for_sat</td><td>True if doing it for Phase Volume Fraction </td></tr>
    <tr><td class="paramname">min_max_limits</td><td>Maximum and minimum values </td></tr>
  </table>
  </dd>
</dl>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_adef72e22883fb36304a2da0099927175_cgraph.png" border="0" usemap="#namespacesolvers__module_adef72e22883fb36304a2da0099927175_cgraph" alt=""/></div>
<map name="namespacesolvers__module_adef72e22883fb36304a2da0099927175_cgraph" id="namespacesolvers__module_adef72e22883fb36304a2da0099927175_cgraph">
<area shape="rect" title="The sparcity of the local CV connectivity is in: small_findrm, small_colm. ngl_its=max no of global i..." alt="" coords="5,46,319,73"/>
<area shape="rect" href="namespacemulti__data__types.html#a5641f05bcbbf1c56b952f99ed0cd1f67" title="Deallocates the required memory to store the derivatives of the shape functions." alt="" coords="367,5,577,47"/>
<area shape="rect" href="namespacecopy__outof__state.html#a0520a99d915a669f52eadab9a438194b" title="@DEPRECATED: Gets memory from packed state This subroutine returns a pointer to the desired values of..." alt="" coords="381,71,563,112"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_adef72e22883fb36304a2da0099927175_icgraph.png" border="0" usemap="#namespacesolvers__module_adef72e22883fb36304a2da0099927175_icgraph" alt=""/></div>
<map name="namespacesolvers__module_adef72e22883fb36304a2da0099927175_icgraph" id="namespacesolvers__module_adef72e22883fb36304a2da0099927175_icgraph">
<area shape="rect" title="The sparcity of the local CV connectivity is in: small_findrm, small_colm. ngl_its=max no of global i..." alt="" coords="413,13,727,39"/>
<area shape="rect" href="namespacemulti__interpolation.html#a4f1475bd24977140d41a9601fce62e7f" title="Mehs to mesh interpollation method, in Diamond DG_Galerkin." alt="" coords="219,5,365,47"/>
<area shape="rect" href="_multiphase___time_loop_8_f90.html#acdc79e479d6b4674e9471ef506d78b2f" title=" " alt="" coords="5,13,171,39"/>
</map>
</div>

</div>
</div>
<a id="aad076a468a68cdb44f63a6290e9c8159"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aad076a468a68cdb44f63a6290e9c8159">&#9670;&nbsp;</a></span>convert_c_and_ct_mat_to_petsc_format()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine solvers_module::convert_c_and_ct_mat_to_petsc_format </td>
          <td>(</td>
          <td class="paramtype">type( state_type ), intent(inout)&#160;</td>
          <td class="paramname"><em>packed_state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__dimensions.html">multi_dimensions</a>), intent(in)&#160;</td>
          <td class="paramname"><em>Mdims</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__matrices.html">multi_matrices</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>Mmat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__ndgln.html">multi_ndgln</a>), intent(in)&#160;</td>
          <td class="paramname"><em>ndgln</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__sparsities.html">multi_sparsities</a>), intent(in)&#160;</td>
          <td class="paramname"><em>Mspars</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>NPHASE</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>: This subroutine converts the C (gradient) and CT (Divergence) matrices into PETSc format Mainly devoted to be used by the PETSc stokes schur solver This can be used when moving from the ICFERST matrix format to PETSc as reference </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">packed_state</td><td>Linked list containing all the fields used by IC-FERST, memory partially shared with state </td></tr>
    <tr><td class="paramname">Mdims</td><td>Data type storing all the dimensions describing the mesh, fields, nodes, etc </td></tr>
    <tr><td class="paramname">Mmat</td><td>Matrices for ICFERST </td></tr>
    <tr><td class="paramname">ndgln</td><td>Global to local variables </td></tr>
    <tr><td class="paramname">Mspars</td><td>Sparsity of the matrices </td></tr>
    <tr><td class="paramname">nphase</td><td>number of phases </td></tr>
  </table>
  </dd>
</dl>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_aad076a468a68cdb44f63a6290e9c8159_icgraph.png" border="0" usemap="#namespacesolvers__module_aad076a468a68cdb44f63a6290e9c8159_icgraph" alt=""/></div>
<map name="namespacesolvers__module_aad076a468a68cdb44f63a6290e9c8159_icgraph" id="namespacesolvers__module_aad076a468a68cdb44f63a6290e9c8159_icgraph">
<area shape="rect" title=": This subroutine converts the C (gradient) and CT (Divergence) matrices into PETSc format Mainly dev..." alt="" coords="940,5,1123,61"/>
<area shape="rect" href="namespacesolvers__module.html#ab1b067219293fc4e2583394acce02bfa" title="In this subroutine the Schur complement is generated and solved using PETSc to update the pressure fi..." alt="" coords="724,13,892,54"/>
<area shape="rect" href="namespacemultiphase__1d__engine.html#ae5be4b78c1796fac4008d398a7cdd0aa" title="Calls to generate the Gradient Matrix, the divergence matrix, the momentum matrix and the mass matrix..." alt="" coords="467,13,676,54"/>
<area shape="rect" href="namespacemultiphase__time__loop.html#a04598d33bda1f46f9537570dbc0119bc" title="This is the main subroutine from which everything is called. It performs the time&#45;loop and therefore ..." alt="" coords="219,13,419,54"/>
<area shape="rect" href="_multiphase___prototype___wrapper_8_f90.html#a0849c5f8b4a25b1987221c6a5a69eeda" title=" " alt="" coords="5,13,171,54"/>
</map>
</div>

</div>
</div>
<a id="a76231fdbfc56035f797b1c21675c02ed"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a76231fdbfc56035f797b1c21675c02ed">&#9670;&nbsp;</a></span>duplicate_petsc_matrix()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public solvers_module::duplicate_petsc_matrix </td>
          <td>(</td>
          <td class="paramtype">type(petsc_csr_matrix), intent(in)&#160;</td>
          <td class="paramname"><em>MAT_A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(petsc_csr_matrix), intent(inout)&#160;</td>
          <td class="paramname"><em>MAT_B</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a4773b0f364c52ef1ca48a3ead9f6693c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4773b0f364c52ef1ca48a3ead9f6693c">&#9670;&nbsp;</a></span>fpi_backtracking()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public solvers_module::fpi_backtracking </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nphase</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type( <a class="el" href="structmulti__data__types_1_1multi__dimensions.html">multi_dimensions</a> ), intent(in)&#160;</td>
          <td class="paramname"><em>Mdims</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__ndgln.html">multi_ndgln</a>), intent(in)&#160;</td>
          <td class="paramname"><em>ndgln</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type( state_type ), dimension( : ), intent(in)&#160;</td>
          <td class="paramname"><em>state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type( state_type ), intent(inout)&#160;</td>
          <td class="paramname"><em>packed_state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:, :), intent(in)&#160;</td>
          <td class="paramname"><em>sat_bak</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:, :), intent(in)&#160;</td>
          <td class="paramname"><em>backtrack_sat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>backtrack_par_from_schema</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(inout)&#160;</td>
          <td class="paramname"><em>Previous_convergence</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(inout)&#160;</td>
          <td class="paramname"><em>satisfactory_convergence</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(inout)&#160;</td>
          <td class="paramname"><em>new_backtrack_par</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>Max_sat_its</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>its</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nonlinear_iteration</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(inout)&#160;</td>
          <td class="paramname"><em>useful_sats</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>res</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>res_ratio</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>first_res</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>:In this subroutine we applied some corrections and backtrack_par on the saturations obtained from the saturation equation this subroutine is detailed in Salinas et al. 2017 doi:10.1002/fld.4357 The method ensures convergence "independent" of the time step. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">nphase</td><td>Number of phases </td></tr>
    <tr><td class="paramname">Mdims</td><td>Data type storing all the dimensions describing the mesh, fields, nodes, etc </td></tr>
    <tr><td class="paramname">ndgln</td><td>Global to local variables </td></tr>
    <tr><td class="paramname">state</td><td>Linked list containing all the fields defined in diamond and considered by Fluidity </td></tr>
    <tr><td class="paramname">packed_state</td><td>Linked list containing all the fields used by IC-FERST, memory partially shared with state </td></tr>
    <tr><td class="paramname">sat_bak</td><td>Backup of the saturation field </td></tr>
    <tr><td class="paramname">backtrack_sat</td><td>Backtrack parameter used </td></tr>
    <tr><td class="paramname">backtrack_par_from_schema</td><td>obtained from diamond/input file </td></tr>
    <tr><td class="paramname">Previous_convergence</td><td>Convergence obtained in the previous attempt </td></tr>
    <tr><td class="paramname">satisfactory_convergence</td><td>If converged true </td></tr>
    <tr><td class="paramname">new_backtrack_par</td><td>New obtained backtracking parameter </td></tr>
    <tr><td class="paramname">Max_sat_its</td><td>Maximum allowed number of saturation iterations </td></tr>
    <tr><td class="paramname">its</td><td>Iterations taken? </td></tr>
    <tr><td class="paramname">nonlinear_iteration</td><td>current non_linear iteration </td></tr>
    <tr><td class="paramname">useful_sats</td><td>Number of useful iterations of the saturation iteration method </td></tr>
    <tr><td class="paramname">res</td><td>residual obtained using the new sigmas obtained with the new saturation in the transport equation </td></tr>
    <tr><td class="paramname">res_ratio</td><td>ratio of residuals between to iterations </td></tr>
    <tr><td class="paramname">first_res</td><td>residual obtained at the first attemp, used as reference </td></tr>
  </table>
  </dd>
</dl>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_a4773b0f364c52ef1ca48a3ead9f6693c_cgraph.png" border="0" usemap="#namespacesolvers__module_a4773b0f364c52ef1ca48a3ead9f6693c_cgraph" alt=""/></div>
<map name="namespacesolvers__module_a4773b0f364c52ef1ca48a3ead9f6693c_cgraph" id="namespacesolvers__module_a4773b0f364c52ef1ca48a3ead9f6693c_cgraph">
<area shape="rect" title=":In this subroutine we applied some corrections and backtrack_par on the saturations obtained from th..." alt="" coords="5,71,156,112"/>
<area shape="rect" href="namespacecopy__outof__state.html#a7d6957a54cc1cc0a38a4a7a90bca1f89" title=": We create a potential to optimize F = sum (f**2), so the solution is when this potential reaches a ..." alt="" coords="217,5,401,47"/>
<area shape="rect" href="namespacesolvers__module.html#a27f681607a9e40b1e99a8f45cd6a940c" title=": This subroutines eliminates the oscillations in the saturation that are bigger than a certain toler..." alt="" coords="204,71,415,112"/>
<area shape="rect" href="namespacesolvers__module.html#a9bba1ef1495c1a4a47a7eea3f2c17719" title=":This subroutines eliminates the oscillations in the saturation that are bigger than a certain tolera..." alt="" coords="219,136,400,177"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_a4773b0f364c52ef1ca48a3ead9f6693c_icgraph.png" border="0" usemap="#namespacesolvers__module_a4773b0f364c52ef1ca48a3ead9f6693c_icgraph" alt=""/></div>
<map name="namespacesolvers__module_a4773b0f364c52ef1ca48a3ead9f6693c_icgraph" id="namespacesolvers__module_a4773b0f364c52ef1ca48a3ead9f6693c_icgraph">
<area shape="rect" title=":In this subroutine we applied some corrections and backtrack_par on the saturations obtained from th..." alt="" coords="756,5,907,47"/>
<area shape="rect" href="namespacemultiphase__1d__engine.html#ad29606c63b241238edd97827aa4564d7" title="Calls to generate the transport equation for the saturation. Embeded an FPI with backtracking method ..." alt="" coords="467,5,708,47"/>
<area shape="rect" href="namespacemultiphase__time__loop.html#a04598d33bda1f46f9537570dbc0119bc" title="This is the main subroutine from which everything is called. It performs the time&#45;loop and therefore ..." alt="" coords="219,5,419,47"/>
<area shape="rect" href="_multiphase___prototype___wrapper_8_f90.html#a0849c5f8b4a25b1987221c6a5a69eeda" title=" " alt="" coords="5,5,171,47"/>
</map>
</div>

</div>
</div>
<a id="a119325e40cdcd54b1766472b55920364"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a119325e40cdcd54b1766472b55920364">&#9670;&nbsp;</a></span>get_anderson_acceleration_new_guess()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public solvers_module::get_anderson_acceleration_new_guess </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>N</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(n), intent(out)&#160;</td>
          <td class="paramname"><em>NewField</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(n, m+2), intent(inout)&#160;</td>
          <td class="paramname"><em>History_field</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(n, m+1), intent(inout)&#160;</td>
          <td class="paramname"><em>stored_residuals</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, optional&#160;</td>
          <td class="paramname"><em>max_its</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(inout), optional, allocatable&#160;</td>
          <td class="paramname"><em>prev_small_matrix</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(inout)&#160;</td>
          <td class="paramname"><em>restart_now</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine provides a new guess based on previous updates and residuals. Use this subroutine to speed up any system being solved by looping. A new guess is computed and returned Method explained in DOI.10.1137/10078356X. </p>
<dl class="section author"><dt>Author</dt><dd>Pablo Salinas </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">N</td><td>Size if the field of interest. Used also to turn vector/tensor fields into scalar fields internally here </td></tr>
    <tr><td class="paramname">M</td><td>Size of the field of iterations available - 2 </td></tr>
    <tr><td class="paramname">NewField</td><td>New guess obtained by the Anderson Acceleration method </td></tr>
    <tr><td class="paramname">History_field</td><td>Past results obtained by the outer solver </td></tr>
    <tr><td class="paramname">stored_residuals</td><td>Past residuals obtained as the (- guessed value + G(guess value) ) </td></tr>
    <tr><td class="paramname">max_its</td><td>Maximum number of iterations </td></tr>
    <tr><td class="paramname">prev_small_matrix</td><td>Contains the previous A'*A, speeds up the method. On exit is updated (M,M) Prepared to be passed unallocated from M = 1 and allocated internally </td></tr>
  </table>
  </dd>
</dl>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_a119325e40cdcd54b1766472b55920364_icgraph.png" border="0" usemap="#namespacesolvers__module_a119325e40cdcd54b1766472b55920364_icgraph" alt=""/></div>
<map name="namespacesolvers__module_a119325e40cdcd54b1766472b55920364_icgraph" id="namespacesolvers__module_a119325e40cdcd54b1766472b55920364_icgraph">
<area shape="rect" title="This subroutine provides a new guess based on previous updates and residuals. Use this subroutine to ..." alt="" coords="991,5,1167,61"/>
<area shape="rect" href="multi__dyncore__dg_8_f90.html#a09c428fa5a27cf3407e6a1bcc917f161" title="Generic subroutine that perform the Anderson acceleration solver. This is storing a set of results fo..." alt="" coords="724,20,943,47"/>
<area shape="rect" href="namespacemultiphase__1d__engine.html#ae5be4b78c1796fac4008d398a7cdd0aa" title="Calls to generate the Gradient Matrix, the divergence matrix, the momentum matrix and the mass matrix..." alt="" coords="467,13,676,54"/>
<area shape="rect" href="namespacemultiphase__time__loop.html#a04598d33bda1f46f9537570dbc0119bc" title="This is the main subroutine from which everything is called. It performs the time&#45;loop and therefore ..." alt="" coords="219,13,419,54"/>
<area shape="rect" href="_multiphase___prototype___wrapper_8_f90.html#a0849c5f8b4a25b1987221c6a5a69eeda" title=" " alt="" coords="5,13,171,54"/>
</map>
</div>

</div>
</div>
<a id="a85646e595797edceed6d3be72173ef7f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a85646e595797edceed6d3be72173ef7f">&#9670;&nbsp;</a></span>initialise_saturation_sums_one()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public solvers_module::initialise_saturation_sums_one </td>
          <td>(</td>
          <td class="paramtype">type( <a class="el" href="structmulti__data__types_1_1multi__dimensions.html">multi_dimensions</a> ), intent(in)&#160;</td>
          <td class="paramname"><em>mdims</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type( state_type ), intent(inout)&#160;</td>
          <td class="paramname"><em>packed_state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>find_scapegoat_phase</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>:Ensure that the saturations at the beginning sum to one, if they do not all the error is compensated in the scapegoat_phase. Normally the last </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Mdims</td><td>Data type storing all the dimensions describing the mesh, fields, nodes, etc </td></tr>
    <tr><td class="paramname">find_scapegoat_phase</td><td>Against which phase we correct the error </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a27f681607a9e40b1e99a8f45cd6a940c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a27f681607a9e40b1e99a8f45cd6a940c">&#9670;&nbsp;</a></span>non_porous_ensure_sum_to_one()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public solvers_module::non_porous_ensure_sum_to_one </td>
          <td>(</td>
          <td class="paramtype">type( <a class="el" href="structmulti__data__types_1_1multi__dimensions.html">multi_dimensions</a> ), intent(in)&#160;</td>
          <td class="paramname"><em>Mdims</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type( state_type ), intent(inout)&#160;</td>
          <td class="paramname"><em>packed_state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>do_not_update_halos</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>: This subroutines eliminates the oscillations in the saturation that are bigger than a certain tolerance and also sets the saturation to be between bounds </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Mdims</td><td>Data type storing all the dimensions describing the mesh, fields, nodes, etc </td></tr>
    <tr><td class="paramname">packed_state</td><td>Linked list containing all the fields used by IC-FERST, memory partially shared with state </td></tr>
    <tr><td class="paramname">do_not_update_halos</td><td>If true do not update halos, to save time in parallel </td></tr>
  </table>
  </dd>
</dl>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_a27f681607a9e40b1e99a8f45cd6a940c_icgraph.png" border="0" usemap="#namespacesolvers__module_a27f681607a9e40b1e99a8f45cd6a940c_icgraph" alt=""/></div>
<map name="namespacesolvers__module_a27f681607a9e40b1e99a8f45cd6a940c_icgraph" id="namespacesolvers__module_a27f681607a9e40b1e99a8f45cd6a940c_icgraph">
<area shape="rect" title=": This subroutines eliminates the oscillations in the saturation that are bigger than a certain toler..." alt="" coords="955,35,1165,76"/>
<area shape="rect" href="namespacesolvers__module.html#a4773b0f364c52ef1ca48a3ead9f6693c" title=":In this subroutine we applied some corrections and backtrack_par on the saturations obtained from th..." alt="" coords="756,5,907,47"/>
<area shape="rect" href="namespacemultiphase__1d__engine.html#ad29606c63b241238edd97827aa4564d7" title="Calls to generate the transport equation for the saturation. Embeded an FPI with backtracking method ..." alt="" coords="467,35,708,76"/>
<area shape="rect" href="namespacemultiphase__time__loop.html#a04598d33bda1f46f9537570dbc0119bc" title="This is the main subroutine from which everything is called. It performs the time&#45;loop and therefore ..." alt="" coords="219,35,419,76"/>
<area shape="rect" href="_multiphase___prototype___wrapper_8_f90.html#a0849c5f8b4a25b1987221c6a5a69eeda" title=" " alt="" coords="5,35,171,76"/>
</map>
</div>

</div>
</div>
<a id="ab1b067219293fc4e2583394acce02bfa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab1b067219293fc4e2583394acce02bfa">&#9670;&nbsp;</a></span>petsc_stokes_solver()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public solvers_module::petsc_stokes_solver </td>
          <td>(</td>
          <td class="paramtype">type( state_type ), intent(inout)&#160;</td>
          <td class="paramname"><em>packed_state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__dimensions.html">multi_dimensions</a>), intent(in)&#160;</td>
          <td class="paramname"><em>Mdims</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__matrices.html">multi_matrices</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>Mmat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__ndgln.html">multi_ndgln</a>), intent(in)&#160;</td>
          <td class="paramname"><em>ndgln</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmulti__data__types_1_1multi__sparsities.html">multi_sparsities</a>), intent(in)&#160;</td>
          <td class="paramname"><em>Mspars</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>final_phase</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(petsc_csr_matrix), intent(inout)&#160;</td>
          <td class="paramname"><em>pmat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type( tensor_field ), intent(inout)&#160;</td>
          <td class="paramname"><em>P_all</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type( vector_field ), intent(inout)&#160;</td>
          <td class="paramname"><em>deltaP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type( vector_field ), intent(in)&#160;</td>
          <td class="paramname"><em>rhs_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">character(len=option_path_len), intent(in)&#160;</td>
          <td class="paramname"><em>solver_option_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(petsc_csr_matrix), intent(inout), optional&#160;</td>
          <td class="paramname"><em>Dmat</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>In this subroutine the Schur complement is generated and solved using PETSc to update the pressure field Matrices need to be in petsc format and pmat is the preconditioned matrix, i.e. pmat = A11- A10(AproxA00^-1)A01. </p>
<dl class="section author"><dt>Author</dt><dd>Pablo Salinas </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">packed_state</td><td>Linked list containing all the fields used by IC-FERST, memory partially shared with state </td></tr>
    <tr><td class="paramname">Mdims</td><td>Data type storing all the dimensions describing the mesh, fields, nodes, etc </td></tr>
    <tr><td class="paramname">Mspars</td><td>Sparsity of the matrices </td></tr>
    <tr><td class="paramname">ndgln</td><td>Global to local variables </td></tr>
    <tr><td class="paramname">final_phase</td><td>This is the final phase to be assembled, in this way we can assemble from phase 1 to final_phase not necessarily being for all the phases </td></tr>
    <tr><td class="paramname">pmat</td><td>INOUT preconditioned matrix, i.e. pmat = A11- A10(AproxA00^-1)A01 </td></tr>
    <tr><td class="paramname">P_all</td><td>Pressure field </td></tr>
    <tr><td class="paramname">deltaP</td><td>Update of pressure from before solving </td></tr>
    <tr><td class="paramname">rhs_p</td><td>RHS of the Pressure system </td></tr>
    <tr><td class="paramname">solver_option_path</td><td>Path of the solver to be used to solve here the system </td></tr>
    <tr><td class="paramname">Dmat</td><td>(optional) is the Matrix multipliying pressure in the continuity equation </td></tr>
  </table>
  </dd>
</dl>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_ab1b067219293fc4e2583394acce02bfa_cgraph.png" border="0" usemap="#namespacesolvers__module_ab1b067219293fc4e2583394acce02bfa_cgraph" alt=""/></div>
<map name="namespacesolvers__module_ab1b067219293fc4e2583394acce02bfa_cgraph" id="namespacesolvers__module_ab1b067219293fc4e2583394acce02bfa_cgraph">
<area shape="rect" title="In this subroutine the Schur complement is generated and solved using PETSc to update the pressure fi..." alt="" coords="5,13,173,54"/>
<area shape="rect" href="namespacesolvers__module.html#aad076a468a68cdb44f63a6290e9c8159" title=": This subroutine converts the C (gradient) and CT (Divergence) matrices into PETSc format Mainly dev..." alt="" coords="221,5,404,61"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_ab1b067219293fc4e2583394acce02bfa_icgraph.png" border="0" usemap="#namespacesolvers__module_ab1b067219293fc4e2583394acce02bfa_icgraph" alt=""/></div>
<map name="namespacesolvers__module_ab1b067219293fc4e2583394acce02bfa_icgraph" id="namespacesolvers__module_ab1b067219293fc4e2583394acce02bfa_icgraph">
<area shape="rect" title="In this subroutine the Schur complement is generated and solved using PETSc to update the pressure fi..." alt="" coords="724,5,892,47"/>
<area shape="rect" href="namespacemultiphase__1d__engine.html#ae5be4b78c1796fac4008d398a7cdd0aa" title="Calls to generate the Gradient Matrix, the divergence matrix, the momentum matrix and the mass matrix..." alt="" coords="467,5,676,47"/>
<area shape="rect" href="namespacemultiphase__time__loop.html#a04598d33bda1f46f9537570dbc0119bc" title="This is the main subroutine from which everything is called. It performs the time&#45;loop and therefore ..." alt="" coords="219,5,419,47"/>
<area shape="rect" href="_multiphase___prototype___wrapper_8_f90.html#a0849c5f8b4a25b1987221c6a5a69eeda" title=" " alt="" coords="5,5,171,47"/>
</map>
</div>

</div>
</div>
<a id="af233b921efdba4e01b5920ccf509ef29"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af233b921efdba4e01b5920ccf509ef29">&#9670;&nbsp;</a></span>scale_petsc_matrix()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public solvers_module::scale_petsc_matrix </td>
          <td>(</td>
          <td class="paramtype">type(petsc_csr_matrix), intent(inout)&#160;</td>
          <td class="paramname"><em>Mat_petsc</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>In this subroutine the matrix is re-scaled based on the formula D^-0.5 * A * D^-0.5 X'= D^-0.5 b; and next X = D^-0.5 * X'; IMPORTANT: the step X = D^-0.5 * X' needs to be done elsewhere store the diagonal before calling this This should allow to deal with high ranges of viscosity ratio for example A is-written. </p>
<dl class="section author"><dt>Author</dt><dd>Pablo Salinas </dd></dl>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_af233b921efdba4e01b5920ccf509ef29_icgraph.png" border="0" usemap="#namespacesolvers__module_af233b921efdba4e01b5920ccf509ef29_icgraph" alt=""/></div>
<map name="namespacesolvers__module_af233b921efdba4e01b5920ccf509ef29_icgraph" id="namespacesolvers__module_af233b921efdba4e01b5920ccf509ef29_icgraph">
<area shape="rect" title="In this subroutine the matrix is re&#45;scaled based on the formula D^&#45;0.5 * A * D^&#45;0...." alt="" coords="724,5,891,47"/>
<area shape="rect" href="namespacemultiphase__1d__engine.html#ae5be4b78c1796fac4008d398a7cdd0aa" title="Calls to generate the Gradient Matrix, the divergence matrix, the momentum matrix and the mass matrix..." alt="" coords="467,5,676,47"/>
<area shape="rect" href="namespacemultiphase__time__loop.html#a04598d33bda1f46f9537570dbc0119bc" title="This is the main subroutine from which everything is called. It performs the time&#45;loop and therefore ..." alt="" coords="219,5,419,47"/>
<area shape="rect" href="_multiphase___prototype___wrapper_8_f90.html#a0849c5f8b4a25b1987221c6a5a69eeda" title=" " alt="" coords="5,5,171,47"/>
</map>
</div>

</div>
</div>
<a id="a9bba1ef1495c1a4a47a7eea3f2c17719"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9bba1ef1495c1a4a47a7eea3f2c17719">&#9670;&nbsp;</a></span>set_saturation_to_sum_one()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public solvers_module::set_saturation_to_sum_one </td>
          <td>(</td>
          <td class="paramtype">type( <a class="el" href="structmulti__data__types_1_1multi__dimensions.html">multi_dimensions</a> ), intent(in)&#160;</td>
          <td class="paramname"><em>mdims</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type( state_type ), intent(inout)&#160;</td>
          <td class="paramname"><em>packed_state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type( state_type ), dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>do_not_update_halos</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>:This subroutines eliminates the oscillations in the saturation that are bigger than a certain tolerance and also sets the saturation to be between bounds </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Mdims</td><td>Data type storing all the dimensions describing the mesh, fields, nodes, etc </td></tr>
    <tr><td class="paramname">packed_state</td><td>Linked list containing all the fields used by IC-FERST, memory partially shared with state </td></tr>
    <tr><td class="paramname">state</td><td>Linked list containing all the fields defined in diamond and considered by Fluidity </td></tr>
    <tr><td class="paramname">do_not_update_halos</td><td>If true do not update halos, to save time in parallel </td></tr>
  </table>
  </dd>
</dl>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacesolvers__module_a9bba1ef1495c1a4a47a7eea3f2c17719_icgraph.png" border="0" usemap="#namespacesolvers__module_a9bba1ef1495c1a4a47a7eea3f2c17719_icgraph" alt=""/></div>
<map name="namespacesolvers__module_a9bba1ef1495c1a4a47a7eea3f2c17719_icgraph" id="namespacesolvers__module_a9bba1ef1495c1a4a47a7eea3f2c17719_icgraph">
<area shape="rect" title=":This subroutines eliminates the oscillations in the saturation that are bigger than a certain tolera..." alt="" coords="1039,64,1220,105"/>
<area shape="rect" href="namespacemultiphase__1d__engine.html#a871f4ede396b430a5194023196511192" title=":In this subroutine the components are solved for all the phases. Systems for each component are asse..." alt="" coords="756,5,991,47"/>
<area shape="rect" href="multi__dyncore__dg_8_f90.html#a171ba3eb037458ea0b2f128257e43588" title="WARNING: Still work in progress." alt="" coords="510,66,665,93"/>
<area shape="rect" href="namespacesolvers__module.html#a4773b0f364c52ef1ca48a3ead9f6693c" title=":In this subroutine we applied some corrections and backtrack_par on the saturations obtained from th..." alt="" coords="798,123,949,164"/>
<area shape="rect" href="namespacemultiphase__time__loop.html#a04598d33bda1f46f9537570dbc0119bc" title="This is the main subroutine from which everything is called. It performs the time&#45;loop and therefore ..." alt="" coords="219,64,419,105"/>
<area shape="rect" href="_multiphase___prototype___wrapper_8_f90.html#a0849c5f8b4a25b1987221c6a5a69eeda" title=" " alt="" coords="5,64,171,105"/>
<area shape="rect" href="namespacemultiphase__1d__engine.html#ad29606c63b241238edd97827aa4564d7" title="Calls to generate the transport equation for the saturation. Embeded an FPI with backtracking method ..." alt="" coords="467,119,708,160"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacesolvers__module.html">solvers_module</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
