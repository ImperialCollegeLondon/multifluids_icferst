<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ICFERST: Introduction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="IC_FERST_Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ICFERST
   &#160;<span id="projectnumber">22-06</span>
   </div>
   <div id="projectbrief">Reservoir simulator based on DCVFEM, Dynamic Mesh optimisation and Surface-based modelling</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Introduction </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="ReadMe"></a>
ReadMe</h1>
<p>(This text is in <a class="el" href="_multiphase___prototype___wrapper_8_f90.html">Multiphase_Prototype_Wrapper.F90</a>) All the contributions to ICFERST in this repository are under AGPL 3.0 license, otherwise refrain from commiting your code to this repository. Each library keeps their original license.</p>
<p>The executable is named icferst</p>
<p>The schema for the ICFERST diamond interface is in ICFERST/schemas/multiphase.rmg</p>
<p>For compilation run the command from the root folder:  
 <CODE>
 <PRE>
./configure --enable-2d-adaptivity && make mp!> </PRE>
 </CODE>
 </p>
<p>ICFERST is property of the NORMS group. See the file COPYRIGHT for a description of the copyright.</p>
<p>For more details please see: <a href="http://multifluids.github.io/">http://multifluids.github.io/</a> or <a href="http://www.imperial.ac.uk/earth-science/research/research-groups/norms/">http://www.imperial.ac.uk/earth-science/research/research-groups/norms/</a></p>
<h1><a class="anchor" id="applications"></a>
Applications</h1>
<p>ICFERST can currently be used to model inertia dominated flows (Navier-Stokes), Stokes flow or Darcy flow. This latter is the most commonly used and the main application of ICFERST and therefore this documentation will focus on it. ICFERST can model single (aquifer thermal energy storage) and multiphase flow with or without wells, compositional with reaction provided by PHREEQC (needs to be installed separately).</p>
<p>The recommended action when generating a new simulation is to build from an input file that has the initial settings that you want. There are examples in ICFERST/test/: Single and multiphase flow (3D_template_porous_case) using wells (Thermal_wells_analytical/multiphase_wells), gravity (BL_with_gravity), capillary pressure (Grav_cap_competing_fast), ATES (Thermal_boussinesq), tunneled BCs (tunneled_BCs), use of Active (Active_tracers) and Passive Tracers (Passive_tracers), drainage (Drainage_test), dissolution (Dissolution_test), use of different region ids to specify petrophysical properties using diamond (3D_template_porous_case) or a input file (Porous_media_general_test), generation of the outfluxes file (BL_fast_fluxes), compositional (Porous_compositional), compressible flow (porous_density_compressible), Robin BCs(Thermal_robin_BCs), three phases with the stone model (Three_phases), adaptive time-stepping using the CFL condition (Adaptive_times_Courant) or based on the stability of the non-linear solver (BL_fast_adapt_ts), anisotropic permeability (Anisotropic_permeability), adapt the mesh within the non-linear solver (Adapt_within_FPI), checkpointing (BL_Checkpointing), Boussinesq approximation (Boussinesq_eos_with_tracers) run in parallel (Parallel_Buckley_Leverett), self potential (SP_ElectroDiffusive_test, SP_ElectroKinetic_test, SP_ThermoElectric_test) thermal modelling (Thermal_analytical_validation) and concentration with dispersion (2D_Dispersive_Saline_Intrusion)</p>
<h1><a class="anchor" id="install_sec"></a>
Installation</h1>
<p>1) Download it from github with the following one-line command  
 <CODE>
 <PRE>
 mkdir ICFERST && cd ICFERST && git init && git remote add -t  main  -f origin git@github.com:Multifluids/icferst.git && git checkout main
 </PRE>
 </CODE>
 </p>
<p>2) Install dependencies  
 <CODE>
 <PRE>
 sudo apt-add-repository ppa:fluidity-core/ppa
 sudo apt-get update
 sudo apt-get install fluidity-dev
 </PRE>
 </CODE>
 </p>
<p>3a) Ubuntu 18.04, modify the .bashrc file in home to include  
 <CODE>
 <PRE>
 export PETSC_DIR=/usr/lib/petscdir/3.8.3
 </PRE>
 </CODE>
 </p>
<p>3b) Ubuntu 18.04, modify the .bashrc file in home to include  
 <CODE>
 <PRE>
 export FCFLAGS="-I/usr/include"
 </PRE>
 </CODE>
 </p>
<p>3b) You may need to explicitly include the python dependencies  
 <CODE>
 <PRE>
 export PYTHONPATH=/usr/lib/python3
 </PRE>
 </CODE>
 </p>
<p>4) Navigate to the root directory of your ICFERST folder  
 <CODE>
 <PRE>
 cd IC-FERST-FOLDER/
 sudo ./configure --enable-2d-adaptivity && make install
 </PRE>
 </CODE>
 </p>
<h2><a class="anchor" id="Scripts"></a>
Useful scripts</h2>
<p>Within the folder ICFERST/tools you can find some useful scripts:</p>
<p>1) If detectors are used you can use detectors_and_stat2csv.py to convert the detectors file in the more readable format .csv</p>
<p>2) To convert from Cubit (exodusII) to a mesh type that ICFERST can open (GMSHv2 format) the scripts exodus2gmsh.py (3D) and 2Dexodus2gmsh.py (2D can be used. exodus2gmsh.py can convert directly into binary format</p>
<p>3) Within scripts_to_make_life_easier there are two scripts to be modified and copied (manually) into /usr/bin to make the use of Diamond and ICFERST much easier.</p>
<h1><a class="anchor" id="diamond"></a>
Diamond interface</h1>
<p>Using the diamond GUI to configure test cases The input files are “EXAMPLE.mpml”. This files can be either manipulated using diamond a GUI, or a text file. To open the diamond GUI for ICFERST this is an example, found in the examples folder in IC-FERST-FOLDER/legacy_reservoir_prototype/tests/3D_BL  
 <CODE>
 <PRE>
 diamond -s IC-FERST-FOLDER/legacy_reservoir_prototype/schemas/multiphase.rng 3D_test.mpml
 </PRE>
 </CODE>
 </p>
<h2><a class="anchor" id="int_conv"></a>
Simplified diamond interface</h2>
<p>The current version of the multiphase schema found within ICFERST/schemas is a simplified version which gets populated internally so it is compatible with Fluidity. This extra population affects when generating checkpointing files that will not be exactly like the original and may need to amended before re-running from a checkpoint (which can be done by opening them and saving). It is important to understand that this conversion exists since it may affect some sections of the code. However, this has been tried to be kept to a minimum and developers can expect a direct connection between diamond and where the option can be found when extracting it.</p>
<p>The simplification mainly focuses on not having to describe the discretisation type, use of defaults for solvers and other settings , density not being defined as a scalar field explicitly, simplified interpolation settings, etc. These can be found in multiphase_prototype_wrapper and are generated using the spud options as defined in the Fluidity manual in the manual folder</p>
<h2><a class="anchor" id="Diamond_manual"></a>
Diamond graphical document</h2>
<p>You can find a tutorial detailing the use of diamond and the different sections in ICFERST/doc/ICFERST_tutorial.pdf Here we will provide a short summary of each section but the graphical document is still highly recommended.</p>
<h1><a class="anchor" id="Parallel"></a>
Using ICFERST in parallel</h1>
<p>ICFERST uses openMPI to run in parallel. The mesh needs to be decomposed initially using the command  
 <CODE>
 <PRE>
 fldecomp -n #CPUs INPUT_MESH
 </PRE>
 </CODE>
  where #CPUs is the number of CPUs and INPUT_MESH is a binary msh file using the gmshv2 format. This can be obtained using ICFERST from an option in diamond/geometry or from an exodusII file using the python conversor from ICFERST/tools Once the mesh is decomposed you can run in parallel using mpirun:  
 <CODE>
 <PRE>
 mpirun -n #CPUs icferst INPUT_mpml
 </PRE>
 </CODE>
 </p>
<p>where INPUT is INPUT_mpml is the mpml file as normally done. As a rule of thumb one wants to have around 15k elements per CPU to have optimal performance.</p>
<h1><a class="anchor" id="Code_structure"></a>
Structure of the ICFERST code</h1>
<p>All the ICFERST code is within the folder ICFERST where the test cases, code, tools and schemas for diamond are stored. Some parts of Fluidity have been slightly modified but in general the Fluidity code is untouched. ICFERST is composed of two main loops. First, it is the time loop and secondly the non-linear loop, which is a Picard method to deal with non-linearities. The time-loop is defined in the multi_timeloop file. From this subroutine we initialise all the necessary fields and start the non-linear loop, within which all the equations to be solved are being called as blocks. In this way, first the momentum equation and velocity are obtained, next the saturation is transported (which also contains within it another non-linear loop) and then all the other transport equations are being solved.</p>
<p>ICFERST solves using a DCVFE formulation, which means that we use two different meshes, a CV mesh and a FE mesh. The CV mesh and associated equations are dealt with in CV_ASSEMB, which for porous media is around 70% of the overall cost. Everything related with the FE mesh is solved for in multi_dyncore However multi_dyncore contains the calls to solve for the different transport equations. So effectively the process is normally time_loop (initialise memory and stuff, including EOS, source terms...) =&gt; multi_dyncore (assemble and solve) =&gt; cv_assemb (assembles the transport equation).</p>
<p>To simplify and standardize the naming of the variables the structures defined in <a class="el" href="namespacemulti__data__types.html" title="This module contains all the ICFERST structures and associated subroutines (allocate/deallocate) Use ...">multi_data_types</a> are used through the code. Normally one or two of those types are created once and used throughout the code, so it is recommended to check in that section what is each variable and use those types either expanding them or creating more.</p>
<h2><a class="anchor" id="code_Diagram"></a>
Code Diagram</h2>
<p> 
 <CODE>
 <PRE>
     ┌─────────────┐     ┌────────────┐    ┌───────────────┐
     │  Adapt mesh ├─────┤Adaptivity  ├────┤ Mesh2Mesh int │
     └─────────────┘     │            │    └───────────────┘
                         └─────┬──────┘
                               │          ┌────────┐
                               │   ┌──────┤  PETSc │
                               │   │      └────────┘
       ┌─────────────┐   ┌─────┴───┴─┐    ┌───────────────────┐
       │ Read input  ├───┤ Fluidity  ├────┤ Generate vtu files│
       └─────────────┘   │           │    │  detectors, stats │
                         └──────┬────┘    └───────────────────┘
                                │                        ┌────────────────────────────────────────────────────┐
                                │                        │multi_phreeqc──────────►Initialise PHREEQCRM        │
                                │                        │Shape functions────────►CV and FE shape functions   │
                         ┌──────┴─────┐                  │                                                    │
                         │  ICFERST   │ Initialisation   │Multi_data_types ──────►Initialise types and memory │
    ┌───────────────────►│  Timeloop  ├─────────────────►│                                                    │
    │                    │            │  of after adapt  │multi_eos  ───────────► Update EOS and petrophysical│
    │                    └──────┬─────┘                  │                        properties                  │
    │                           │Start non-linear        │Extract from state ────►Read from diamond and       │
    │        ┌─────────────────►│ loop                   │                        adaptive-time-stepping      │
    │        │                  │                        └────────────────────────────────────────────────────┘
    │        │           ┌──────┴───────────┐
    │        │           │Assemble and solve│      ┌───────────────────┐  ┌───────────┐ ┌───────────────────┐
    │        │           │momentum equation ├─────►│  multi_dyncore    ├─►│ cv_assemb ├─► Assemble C and Ct │
    │        │           └──────┬───────────┘      └─┬─────────────────┘  └───────────┘ └───────────────────┘
    │        │                  │                    │    ┌───────────┐
    │        │                  │                    ├───►│Assemble M │
    │        │                  │                    │    ├───────────┴────────────┐     ┌────────────┐
    │        │                  │                    │    │ Solve  (M  C) (u) = (f)├────►│multi_solver│
┌───┴─────┐  │      ┌──────────►│                    └───►│        (Ct Mp)(p)   (g)│     └────────────┘
│ Advance │  │      │           │                         │ Mp/=0 for compressible │
│  time   │  │      │   ┌───────┴────────────┐            └────────────────────────┘
└───┬─────┘  │      │   │If multiphase solve │     ┌─────────────┐        ┌─────────┐   ┌───────────┐
    │        │      │   │transport saturation├────►│multi_dyncore├───────►│cv_assemb│──►│multi_pipes│
    │        │      │   └────────┬───────────┘     └─────┬───────┤        └─────────┘   └───────────┘
    │        │      │ Loop until │                       │  ┌─────────────────────────────┐
    │        │      │ converge   │                       └──┤ solve and backtrack solution│
    │        │      └────────────┤                          └──────────────────────────────┘
    │   ┌────┴───────────┐       │                 ┌─────────────┐
    │   │ Adapt time-step│       │                 │Temperature  ├───────┐
    │   │   size         │       │                 ├─────────────┤       │  ┌─────────────┐  ┌─────────┐   ┌───────────┐
    │   └────┬───────────┘       │                 │Concentration├───────┼─►│multi_dyncore├──►cv_assemb│──►│multi_pipes│
    │        │                   │───────────────► ├─────────────┴───────┤  └────┬────────┘  └─────────┘   └───────────┘
    │        │                   │                 │ActiveTracers/Species├──┐    │   ┌────────────┐
    │        │ Loop until        │                 ├─────────────┬───────┤  │    └──►│solve system│
    │        │ convergence       │                 │Compositional├───────┴──┤        └────────────┘ ┌─────────────────────────┐
    │        └───────────────────┤                 └─────────────┘          └──────────────────────►│PHREEQC Update Species   │
    │                            │                                                                  └─────────────────────────┘ 
    │                            │       ┌──────────────┐       ┌──────────────┐   ┌─────────┐   ┌───────────┐
    │                            ├──────►│PassiveTracers├───────►multi_dyncore ├──►│cv_assemb│──►│multi_pipes│
    │                            │       └──────────────┘       └┬─────────────┘   └─────────┘   └───────────┘
    │                            ├─────────────┐                 │  ┌────────────┐
    │                    ┌───────┴──────────┐  │                 └─►│solve system│
    │                    │  Output vtu      │  │                    └────────────┘
    │                    │         outfluxes│  │
    │                    └───────┬──────────┘  │   ┌──────────────┐
    │                            │             └──►│SelfPotential │
    │                     ┌──────┴────┐            └──────────────┘
    │                     │ Adapt mesh│
    │                     └──────┬────┘
    └────────────────────────────│
                              ┌──┴──┐
                              │ END │
                              └─────┘
 </PRE>
 </CODE>
  </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
