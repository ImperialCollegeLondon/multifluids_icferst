\chapter{Configuring \fluidity}\label{chap:configuration}

\section{Overview}
A \fluidity\ simulation is configured by creating a \fluidity\ options (or flml) file using
Diamond, which is the Graphical User Interface (GUI). 
The left-hand pane of Diamond allows users to browse the
\emph{options tree}, while the right-hand pane provides brief documentation
about the option and is where users enter input data. 

This chapter aims to provide a detailed description of all the options in
the tree.  From section~\ref{Sect:OptionsTree} onwards, \fluidity\ options are
described in the order in which they appear in Diamond.  Prior to this are
some important general notes about the different types of options and, in
particular, how to work with fields in \fluidity.

\section{Options syntax}
\index{options!syntax}
\fluidity\ options files, or flml files, are XML files whose grammar is defined by the
fluidity options schema \verb+fluidity_options.rng+. XML files have a
tree-like structure of elements containing other elements. This structure is
reflected in the left hand pane of Diamond, the GUI which
is used to write flml files.

The flml file can also be edited with a standard editor and the options written
in text and in code using the Spud library on which the \fluidity\ options
system is based. A location in the options tree can be written as a path,
much like the path of a file on disk. So, for example, the option
controlling the physical dimension of the problem domain is written as
\option{/geometry/dimension}. This should be read as the \option{dimension}
option which is found under \option{geometry} which is in turn at the top
level of the options tree. In Diamond, and in the flml file, the absolute
top level element is always \option{fluidity\_options} but this element is
always discarded from paths. Figure \ref{fig:geometry_dimension}\ shows a
Diamond screen shot open at the \option{/geometry/dimension} option. Further
documentation of the Spud system is available in \citet{ham2009}\ and from
\href{http://amcg.ese.ic.ac.uk/spud}{the Spud website}.

\begin{figure}[ht]
  \centering
  \fig[width=.7\textwidth]{geometry_dimension}
  \caption{A Diamond screenshot showing the \option{/geometry/dimension}
    option. Note that the option path is displayed at the bottom of the
    diamond window}
  \label{fig:geometry_dimension}
\end{figure}

\subsection{Allowed Characters}
Only certain characters are recognised by the options dictionary, which contains the flml input once it is read into fluidity. Therefore only the following letters are allowed in any input field:

\begin{verbatim}
 /_:[]1234567890qwertyuioplkjhgfdsazxcvbnmMNBVCXZASDFGHJKLPOIUYTREWQ
\end{verbatim}

Comment boxes may contain any characters. 

\subsection{Named options}
\index{options!names}
Some options in the tree, such as fields and meshes, have name
attributes. The name attribute is represented in the flml file with a double colon so that,
for example, the coordinate mesh has options path\onlypdf\linebreak
\option{/geometry/mesh::CoordinateMesh}. Note that this differs from the
convention in the Diamond interface in which name attributes are given in brackets. Figure
\ref{fig:mesh_name}

\begin{figure}[ht]
  \centering
  \fig[width=.7\textwidth]{mesh_name}
  \caption{A Diamond screenshot showing the \option{/geometry/mesh::Coordinate}
    option. Note that the name is shown in brackets in the main Diamond
    window but after double colons in the path in the bottom bar.}
  \label{fig:mesh_name}
\end{figure}

Names of objects (fields, material phases, meshes, etc.) should be camel cased (MyOwnField) and not contain spaces or underscores. Furthermore, the characters \verb+/:[]+ are prohibited as these have special meanings in the options dictionary inside \fluidity. 

\section{The options tree}\label{Sect:OptionsTree}
The top level of the options tree contains the following compulsory elements:

\begin{itemize}
\item Simulation Name
\item Problem Type
\item Geometry
\item IO
\item Timestepping
\item Physical Parameters
\item Material/Phase
\end{itemize}

The first six of these are described here.

\subsection{Simulation Name}
The simulation name is the base name for all output files. For example if you set the simulation name to foo then your statistics output file will be called foo.stat

\subsection{Problem Type}
Setting problem type gives fluidity a hint as to what sort of simulation you are conducting and therefore what combinations of options are likely to be valid. If you do not know which category applies to your problem, choose "fluids". 
\subsection{Geometry}
This element contains all the options required to specify the geometry of the mesh and the accuracy of the finite element discretisation.

\subsubsection{Dimension}
\index{dimension}
The dimension of the domain of your problem. This can be 1, 2 or 3.
Be careful, once you set the dimension you can't change it again!
This is necessary to ensure that all vectors and tensors are of the correct
dimension.

\subsubsection{Meshes}
Meshes are the finite element spaces on which your problem is solved. Meshes
are either read from file or are derived from other meshes. Mesh options are
described in detail in section~\ref{Sect:Mesh}.  There is only one required
mesh: the CoordinateMesh. Some settings or fields have
specific mesh requirements. These are discussed under the appropriate
options.

\subsubsection{Quadrature}
\index{quadrature!options}
\fluidity\ uses numerical quadrature to integrate the equations over each
element. There is a performance/accuracy trade off in quadrature: the more
quadrature points are employed, the more accurate the integrals are but
the more expensive the assembly operation is. Quadrature rules in \fluidity\ are categorised by the degree of the polynomial which they will integrate
exactly. The higher the degree of the quadrature rule, the more quadrature
points will be employed. As a general rule of thumb, the quadrature
degree employed should be at least $\max(2n_{\vec{u}+1},2n_p)$ where
$n_{\vec{u}}$ is the degree of the elements employed for velocity and $n_p$
is the degree of the elements employed for pressure. This means that degree
4 quadrature is sufficient for most of the fluidity configurations currently
in use.

The quadrature degree is specified by setting \option{/geometry/quadrature/degree}.

\subsubsection{Spherical Earth}
\index{spherical earth}

Enabling \option{/geometry/spherical\_earth} informs \fluidity that your simulation is being carried out in an Earth like geometry, that is, a three dimensional geometry with gravity pointing towards the centre of the coordinate system. This has implications for various options and terms such as wind forcing (see section \ref{Sect:wind_forcing}), the calculation of buoyancy and the `direction' of absorptions (see \ref{Sect:Source}).

If this option is checked, wind forcing and \eg momentum forcing from bulk formulae (see \ref{Sect:bulk_formulae}) will automatically be rotated and applied in the direction tangential to the Earth's surface. It will also result in absorption terms set through the options tree being rotated and applied in the longitudinal, latitudinal and radial directions respectively. Additionally, in many terms such as the buoyancy density, the direction of gravity is hard coded and calculated at explicitly at Gauss points when this option is enabled. Thus, if enabling this option, the direction of gravity specified in the options tree (see \ref{Sect:Gravity}) must be set via a python function representing the inward normal to the sphere. Note however that the viscosity and diffusion operators are currently not rotated automatically and thus the user must carry such rotations out themselves. And example in which the viscosity is rotated is giving in section \ref{sect:tides_in_the_med}.

Under \option{/geometry/spherical\_earth} the user must select \option{linear\_mapping} or \option{superparametric\_mapping}. The former results in cords between nodes being approximated as linear segments whilst the latter gives a better approximation to the Earth's shape through approximating cords with a higher order polynomial. The order of the polynomial is given by the degree of the mesh on which gravity is located.   

\subsubsection{Ocean Boundaries}\label{sec:ocean_boundaries}
\index{boundary conditions!ocean}
These options are required if you are running an ocean simulation with a
free surface or with various other ocean options which require the code to
know where the ocean surface and bed lie.
\option{/geometry/ocean\_boundaries/top\_surface\_ids} and
\onlypdf\linebreak\option{/geometry/ocean\_boundaries/bottom\_surface\_ids}
are lists of boundary tags from your input mesh which lie on the ocean
surface and bed respectively.

It is not usually necessary to change the settings for either of the scalar fields under this option. 

\subsection{IO}
These options control the frequency and form of model outputs.
\subsubsection{Dump format}
\index{vtk}
The file format used to output fields to disk. At this stage, vtu is the
only allowed format.

\subsubsection{Dump period}
This is the interval between the state fields being output to disk. You should usually start by setting this to a rather low value (possibly as short as your timestep) for testing and then increase it for production runs once you know how your configuration works. The value can be specified as either a constant or python function.

It is possible to swap \option{/io/dump\_period} for \option{/io/dump\_period\_in\_timesteps} to specify that you wish to have a dump every fixed number of timesteps.

\subsubsection{Output mesh}
\index{mesh!output}

All fields will be interpolated onto the same mesh for output. Usually the
CoordinateMesh is the right choice. If you have fields that are of
higher order than the selected output mesh you will lose 
accuracy. Interpolating all fields to a higher order mesh for output may give
very large dump files however. If any 
of the fields in the output is discontinuous, the mesh in the output file
will be a discontinuous version of the mesh selected here.

\subsubsection{Disable dump at start}

A dump is normally performed at the start of the simulation. This options disables that.

\subsubsection{Disable dump at end}

A dump is normally performed at the end of the simulation. This options disables that.

\subsubsection{CPU dump period}

This outputs dumps at specified CPU times. Not recommended.

\subsubsection{Wall time dump period}

Outputs at specified walltime (real time) periods. Not recommended.

\subsubsection{Max dump file count}

Limits the number of dumps by overwriting the previous dumps after the number specified here.

\subsubsection{Convergence}

You can check certain fields for convergence during nonlinear iterations.  To do this switch on \option{/timestepping/nonlinear\_iterations} and \option{/timestepping/nonlinear\_iterations/tolerance} and switch on the convergence option under the fields that you want to check for convergence. 

It is possible to enable the creation of a convergence file, giving details of the convergence of each field over the global nonlinear iteration loop. The .convergence file is in the same format as the .stat file. In order to do this, switch on 
\option{/io/convergence}  and \option{/io/convergence/convergence\_file}.  You still need the options in the above paragraph.

\subsubsection{Checkpointing}
\index{checkpointing}
\label{sect:configuring_fluidity_checkpointing}
Enables checkpointing, which saves sufficient information (including a new flml options file) to restart a simulation, i.e., to continue the simulation after it stopped. You must specify how often to checkpoint in terms of the number of dumps. There
are also options to checkpoint at the start of the simulation and at the
end. This latter is useful when running on batch systems that have a time
limit.

Up to five sets of files are created when checkpointing:
\begin{enumerate}
\item Mesh files - The from\_file meshes, in triangle format. Surface IDs
  and (if present) region IDs are written to the mesh files, and adaptivity
  is supported. In parallel a triangle mesh is written for each process.
\item Halo files (in parallel) - Halo information for each process.
\item Field files - A vtu is written for each mesh with prognostic fields in
  each state and (in parallel) for each process.
\item Checkpointed option file - A new FLML file, with the from\_file mesh
  set to read the checkpoint mesh files and the prognostic fields set
  to initialise from the checkpoint field files.
\item Checkpointed detector files - Two files related to checkpointing of
  detectors are created.
\end{enumerate}

The first checkpointed detector file has the extension .groups and contains
a header with the names of the groups of detectors in the order they were
read in the simulation. It also contains information about the number of
detectors in each group. This is to guarantee that when restarting from a
checkpoint, the detectors will be read in the same order and consequently
will be saved in that same order into the output detector file for
consistency.  The second checkpointed detector file has the extension
.positions.dat and contains the last position of the detectors at the time 
of checkpointing, in binary format.

No checkpointed detector files will be created if only static detectors are
defined in Diamond, since the position of these detectors remains always the
same. This is mainly used when Lagrangian detectors are set that are
advected by the flow and hence, their position changes as the simulation
proceeds.

At the same time as creating the two files related to checkpointing of
detectors, the detector options in the options tree or Diamond are updated
so that in the new flml file the detectors are set to initialise from the
checkpoint detectors files \\
(\option{/io/detectors/detector\_array/from\_checkpoint\_file} or \\
\option{/io/detectors/lagrangian\_detector/from\_checkpoint\_file}). For
simplicity, the static detectors are also read from the checkpoint file that
contains the position of all detectors, static and Lagrangian
(\option{/io/detectors/static\_detector/from\_checkpoint\_file}).

Checkpoint filenames all end with [dump
no.]\_checkpoint[-[process]].[extension], where the process number is added
to the mesh, halo and field files in parallel.  The checkpoint detectors
filenames contain \_det after [dump no.]\_checkpoint.

\index{checkpointing!restarting}
To restart from a checkpoint, specify the checkpointed FLML file as input.

\subsubsection{Stat}
\index{stat file}
Contains additional options for handling stat files, for example outputting
a stat file at the start (timestep zero) and outputting stat data before and
after an adapt.

There are futher options under individual fields, for example to exclude data from the stat file.

\subsubsection{Detectors}
\index{detectors!options}
Note that the algorithm used to determine the element containing a detector (of
any kind) assumes that the detector is known to be within the simulation domain.
For points outside the simulation domain the field values will be extrapolated
if within 0.1 (in ideal space) from any element, or set to zero otherwise.

Detectors are set in Diamond with the \option{/io/detectors} option. The detectors can be set to be static detectors, \option{/io/detectors/static\_detector}, Lagrangian detectors \\
\option{/io/detectors/lagrangian\_detector} or an array of detectors, \\
\option{/io/detectors/detector\_array}.

When choosing to set detectors using an array, the total number of detectors
needs to be specified in
\option{/io/detectors/detector\_array/number\_of\_detectors} and the type of
detectors is indicated with the option
\option{/io/detectors/detector\_array/static} or \\
\option{/io/detectors/detector\_array/lagrangian}.

\index{Python!detector positions}
Examples \ref{examp:python_function_detectors} and
\ref{examp:python_function_detectors_1} illustrate the use of a Python
function to set an array of detectors, that can be static or Lagrangian.

\begin{example}
  \begin{lstlisting}[language=Python]
def val(t):
            import math

            ret=[]
            for i in range(100):
                    ret.append([-2.5,(-0.495 + i * 0.01)])

            return ret
  \end{lstlisting}
  \caption{A Python function setting 100 detectors. This
  example illustrates that it is possible to use a Python function to set an array of detectors.}
  \label{examp:python_function_detectors}
\end{example}

\begin{example}
  \begin{lstlisting}[language=Python]
def val(t):
            import math

            ret=[]
            for k in range(100,2000,100):
                for j in range(7000,25100,100):
	               for i in range(7000,25100,100):
		             ret.append([i,j,k])

	return ret
  \end{lstlisting}
  \caption{A Python function setting 622459 detectors uniformly distributed
    at intervals of 100 m in the three orthogonal directions. They cover 19 z planes, from z=100 to z=1900, with 32761 detectors in each plane, from
    x=7000 to x=25000 and y=7000 to y=25000.}
  \label{examp:python_function_detectors_1}
\end{example}

The output of the detectors is an ascii file called
\option{name\_of\_simulation.detectors} where the name of the simulation has
been indicated in \option{/simulation\_name}. If binary output
\option{/io/detectors/} \option{binary\_output} option is enabled then the file containing the detector data is called
\option{name\_of\_simulation.detectors.dat} and in this case \option{name\_of\_simulation.detectors} contains only the header with the
information about the detectors (name of each detector, in which column the
position of each detector is stored, etc.).

\subsubsection{Log output}

Enables additional output to the screen or log file. Usually controlled
using the -v option when running \fluidity. However, a useful option for
logging memory diagnostics can be switched on here.

\subsection{Timestepping}
\index{time!step}
These options control the start and end time of the simulation as well as options regarding timestep size.

\subsubsection{Current time}
This is the model time at the start of the simulation. In most cases this is likely to be zero. It can be non-zero when continuing a simulation from a checkpoint.

\textbf{Time units}

If your simulation contains real data, for example when using
\option{ocean\_forcing}, \fluidity\ must know how to map simulated time onto
real time. This option allows the user to specify the ``real-world'' start
time of the simulation.  The input is a string of the form:
\begin{lstlisting}[language=bash]
seconds since 1992-10-8 15:15:42.5 -6:00 
\end{lstlisting} 

which indicates seconds since October 8th, 1992 at 3 hours, 15 minutes and
42.5 seconds in the afternoon in the time zone which is six hours to the
west of Coordinated Universal Time (i.e. Mountain Daylight Time). The time
zone specification can also be written without a colon using one or
two-digits (indicating hours) or three or four digits (indicating hours and
minutes).


\subsubsection{Timestep}
The simulation timestep. If adaptive timestepping is not used this will
define the size of the timestep used throughout the simulation.  If adaptive
timestepping is used this option defines only the size of the first
timestep.

\subsubsection{Finish time}
The model time at which the simulation should halt. Note that the simulation
may overrun slightly due to roundoff in calculating the current time or if
the timestep does not divide the simulation time exactly.

\subsubsection{Final timestep}

Rather than specify a finish time, the final timestep may be specified. This is the number of timestep after which the simulation will stop.

\subsubsection{CPU time limit}

This option will stop the simulation after the CPU time reaches this limit.
This option is useful when coupled with
\option{/io/checkpointing/checkpoint\_at\_end} enabled.

\subsubsection{Wall time limit}

This option will stop the simulation after the wall time (real time) reaches
this limit. This option is useful when coupled with
\option{/io/checkpointing/checkpoint\_at\_end} enabled.

\subsubsection{Nonlinear iterations}
Nonlinear quantities in the equations are represented by their last known
values. It may be necessary to solve the equations more than once to produce
better approximations to those last known values for reasons of accuracy or
stability. Unless there are reasons for doing this, set this value to 2.

\subsubsection{Adaptive timestep}

This option allows the timestep, $\Delta T$, to vary throughout the run, depending on the 
Courant-–Friedrichs-–Lewy (CFL) number.  There are several sub-options here. The
\option{\ldots/requested\_cfl} is the desired upper limit of the CFL. A value of 5-10 is usual
here. \fluidity\ will increase the timestep if the CFL number is less than this value and decrease
it if the CFL is greater than this. The \option{\ldots/minimum\_timestep} and 
\option{\ldots/maximim\_timestep} options limit the timestep. The option 
\option{\ldots/increase\_tolerance} determines
the rate of growth in the timestep. A value of 1.5 indicates the timestep can grow by
at most, 50\%. There is no limit on the rate of decrease. Note that if a timestep fails
to meet the CFL limit imposed it is not re-run, but the timestep is decreased for the next
iteration. Finally, a desired $\Delta T$ can be calculated at the first time iteration by
switching on the option: \option{\ldots/at\_first\_timestep}

\subsubsection{Steady state}
It is possible to run fludity until it converges to a steady state; this is sometimes useful for initialising a problem. In order to do this, switch on \option{/timestepping/steady\_state} and set a tolerance. 

\subsection{Physical parameters}
These options control global physical quantities.

\subsubsection{Gravity}\label{Sect:Gravity}
\index{gravity}
The importance of buoyancy is discussed in section \ref{sect:hydrostacy}. This
requires a gravitational field to be set and involves both its magnitude
(\eg \mss[9.8]) and a vector field specifying the direction in which gravity
points. For a 3D simulation in a flat domain with gravity pointing in the
negative z direction you would set \verb+value(WholeMesh)+ for this field to
the vector (0.0, 0.0, -1.0). For a gravitational force with spatially
varying direction, e.g. on the Earth considered in Cartesian space with
gravity pointing in the negative radial direction you could use a Python
function of the form
\begin{example}
  \begin{lstlisting}[language=Python]
def val(X, t):
   from math import sqrt
   radius=sqrt(X[0]**2+X[1]**2+X[2]**2)
   rx=X[0]/radius
   ry=X[1]/radius
   rz=X[2]/radius
   return (-rx, -ry, -rz)
  \end{lstlisting}
  \caption{A Python function returning a vector pointing in the negative radial direction.}
\end{example}

\subsubsection{Coriolis}
\index{Coriolis!options}

\fluidity\ supports the specification of the Coriolis term (section
\ref{sect:coriolis}) in a number of different ways. The following options
are available:

\begin{enumerate}
  \item \option{f\_plane} -- a single float is prescribed which corresponds to
        $f_0$ in \eqref{eq:f-plane};
  \item \option{beta\_plane} -- here two floats are prescribed, $f_0$ and
        $\beta$ in \eqref{eq:beta-plane};
  \item \option{sine\_of\_latitude} -- here the Coriolis parameter from
        \eqref{eq:coriolis_parameters} is used and $\Omega$, 
        $R_{\textrm{earth}}$ and $\textrm{latitude}_0$ are defined as floats with
        latitude calculated via 
        $\phi = y/R_{earth} + \textrm{latitude}_0$;
  \item \option{on\_sphere} -- here $\Omega$ the rotation vector pointing in the
        inertial frame $z$ direction  \eqref{eq:on_sphere_rotation} is set,
        note this is the direction pointing from the centre of mass to the North
        Pole on the Earth;
 \item \option{python\_f\_plane} -- time dependent python input
       prescribing a single float which corresponds to
       $f_0$ in \eqref{eq:f-plane} - see example \ref{ex:python_f_plane}.
\end{enumerate}

Recall that there is a factor $2$ relationship between $f$ and $\Omega$
\eqref{eq:f_omega} --- make sure you don't get caught out by this.

\begin{example}
\begin{lstlisting}[language = Python]
if t < 4000.0:
  omega = 3.0
elif t < 6000.0:
  omega = 2.5
elif t < 8000.0:
  omega = 2.0
elif t < 10000.0:
  omega = 1.5
elif t < 12000.0:
  omega = 1.0
elif t < 14000.0:
  omega = 0.5
else:
  omega = 0.0

return 2.0 * omega
\end{lstlisting}
\caption{\option{python\_f\_plane} definition, sweeping through a number of
         rotation rates. Note the factor of $2$ between $f$ and $\Omega$ (see
         equation \eqref{eq:f_omega}).}
\label{ex:python_f_plane}
\end{example}


\section{Meshes}\label{Sect:Mesh}

A mesh defines the discrete
function space in which the values of one or more fields lie. For example, the mesh
defines what degree of polynomials are employed on each element, whether the
field is continuous or discontinuous between elements, and whether the
domain is periodic in any direction. 

Meshes are defined in the flml file by \option{/geometry/mesh} options. The
mesh associated with each field is referred to by name in the
\option{\ldots/mesh} option under that field.

\subsection{Reading meshes from file}
\index{mesh!input}
There must always be one mesh which is read in from a set of files in
triangle format. This is usually the \option{CoordinateMesh}. To specify the
triangle files from which the coordinate mesh should be read, set the
\option{file\_name} attribute of
\option{/geometry/dimension/mesh::CoordinateMesh/from\_file} to the basename
of the triangle files (that is, the filename without .node, .ele, etc.)

The coordinate mesh read in from file will always have linear elements and
the Coordinate field is always continuous between elements.

For information on generating meshes in triangle format, see chapter
\ref{chap:meshes}. 

\subsection{Deriving meshes from other meshes}
\index{mesh!derived}
The alternative to reading a mesh from a file is to derive it from another
mesh. This is necessary when for instance we wish to derive a mesh with
different continuity or elements than the original mesh. 
For example, if we have a \option{CoordinateMesh} as our input mesh read 
from file, it is possible to derive a \option{VelocityMesh} from it
by adding \option{/geometry/mesh::VelocityMesh}, selecting 
\option{from\_mesh} under it and there selecting
\option{mesh::CoordinateMesh}. If nothing further is specified 
under the new mesh, the derived mesh will be exactly the same as the mesh
it is derived from.

The more interesting case occurs where we wish to derive a mesh with
different continuity or elements from the original mesh. To specify a
discontinuous mesh, under \option{\ldots/from\_mesh} enable
\option{mesh\_continuity} and select \option{discontinuous}.

Similarly, to specify a mesh with higher polynomial degree elements, enable
\option{mesh\_shape} under \option{\ldots/from\_mesh} and set
\option{polynomial\_degree}.

Meshes with any name can be added. Only the name \option{CoordinateMesh} 
is special, as it will be used to store the coordinates of the mesh. This 
is also the only required mesh. \option{VelocityMesh} and \option{PressureMesh}
are only provided as suggested names as quite often the pressure 
and velocity fields need to be on a different mesh 
than the coordinate mesh, e.g. for \PoDGPt. It is however 
not required that the velocity is defined on a mesh with the name
\option{VelocityMesh}, nor does the pressure field have to be on a mesh
with the name \option{PressureMesh}. If for instance the mesh needed 
for pressure is the same as your \option{CoordinateMesh}, e.g. 
for \Poo or \Pzero\Pone, the pressure can be defined directly on
the \option{CoordinateMesh} and no extra mesh is needed.

\subsubsection{Shape function}

This option is used to specify the degree of polynomial which should be used
for the shape functions on each element of the mesh. If not selected, the
shape functions will be the same as those on the mesh from which this mesh
is derived.

\subsubsection{Continuity}

This option can be set to discontinuous to derive a discontinuous mesh from
a continuous one. Note that it is not possible to derive a continuous mesh
from a discontinuous mesh.

\subsubsection{Periodic}\label{Sect:periodic}
\index{mesh!periodic} 
\index{periodic domain} 

To specify a periodic domain in Diamond, add a new mesh under
\option{/geometry/mesh}.  Select \onlypdf\linebreak
\option{\ldots/from\_mesh/mesh::CoordinateMesh} and then turn
on \onlypdf\\
\option{\ldots/from\_mesh/periodic\_boundary\_conditions} for each dimension
that is periodic. There are three fields that need to be completed: the
surface IDs of one side, the surface IDs of the opposite side and a python
function (\option{coordinate\_map}) which contains the necessary mapping
function.

For example, suppose that the domain is the unit square shown in figure
\ref{fig:periodic}\ which is to be periodic in the $x$ direction. We
designate surface ID 1 as the \emph{physical boundary}\ and surface ID 2 as the
\emph{aliased boundary}. We therefore enter 1 in
\option{\ldots/physical\_boundary\_ids}\ and 2 in
\option{\ldots/aliased\_boundary\_ids}. The \emph{coordinate map}\ function
takes a point on the \emph{aliased}\ boundary to the corresponding point on
the \emph{physical}\ boundary. In this case, the appropriate function is:
\begin{lstlisting}[language=Python]
def val(X,t):
    result = list(X)
    result[0]=result[0]-1.0
    return result
\end{lstlisting}

\begin{figure}[ht]
  \centering
  \xfig{configuring_fluidity_images/periodic_domain}
  \caption{Periodic unit square with surface IDs 1-4 shown.}
  \label{fig:periodic}
\end{figure}

Meshes that are required to be periodic can now be derived from this
periodic mesh. Note that the periodic mesh must be directly derived from the
mesh which has been read \option{from\_file}. It is not possibe to derive a
periodic mesh from a \option{from\_mesh}\ mesh.

\subsubsection{Extruded meshes}\label{Sect:extruded}

It can be advantageous to have a mesh in which all the nodes line up in
vertical lines. To achieve this effect within \fluidity, it is possible to
read in a mesh in $n-1$ dimensions and extrude it along the $n$-th
dimension. An extruded mesh is specified using the
\option{\ldots/from\_mesh/extrude}\ option. 

Under this option it is necessary to set the \option{regions/bottom\_depth}. This is
a scalar value which gives the depth, a positive value. The extent of the
domain in $n$-th dimension will be $(0,-bottom_depth)$. This value may be
set either as a constant or as a Python function. In the latter case,
function will be a function of space and time. Note in this case that the
space argument \lstinline[language=Python]+X+ will be $n-1$-dimensional. See
section \ref{Sect:setting_with_python}\ for a full explanation of the use of Python functions to
prescrible field values. In this case, the depth is essentially a scalar
field over the $n-1$ dimensional parent mesh. The time argument which
will be passed to the function is the simulation start time and the function
will \emph{not}\ be re-evaluated during the simulation.

The second option which must be set is the
\option{\ldots/sizing\_function}. This specifies the mesh spacing
along the $n$-th dimension. It may once again be a constant or a Python
function. In the latter case, it will be a function of all $n$ dimensions
which facilitates the mesh spacing varying in depth as well as in the
horizontal. Once again, the function will be evaluated only at simulation
start. 

It will usually be advantageous to specify the surface ID to be associated
with the top and bottom boundaries, so that boundary conditions can be
associated with them. This is achieved using the
\option{\ldots/top\_surface\_id}\ and
\option{\ldots/bottom\_surface\_id}\ options. The lateral boundaries
of the extruded mesh will inherit the surface IDs associated with the the
boundaries of the parent (non-extruded) mesh.

It is possible to specify different options for different regions of the
mesh by adding multiple \option{\ldots/extrude/regions}\ options and changing
them to the generic rather than the \option{regions::WholeMesh}\
version. The new regions need to be named and the region IDs to which they
apply specified.

As well as extruding 2D meshes (where only the $x$ and $y$ coordinates are
specified in the triangle file), given a pseudo 2D mesh on a spherical
shell, \fluidity\ can perform and extrusion in the radial direction. To
perform such an extrusion simply enable the options as noted above and
additionally check the \option{/geometry/spherical\_earth option}. With this
option enabled \fluidity\ will then perform the specified extrusion towards
the centre of the sphere.

Extrusions on the sphere can be performed such that the `depth' of the extrusion
conforms to bathymetic data. To extrude according
to bathymetry \fluidity\ must be provided with a netCDF data file containing
three columns of data giving the longitude, latitude and depth
of each point respectively. The name and location of this data file must then be
entered under \option{\ldots/extrude/regions/bottom\_depth/from\_map}.
To avoid the depth at coast dropping to zero the user may also enter a minimum
depth under the \option{\ldots/from\_map/min\_depth} option. Note however, that
if a minimum depth is specified, this will be applied throughout the domain.

\subsubsection{Extruded periodic meshes}\label{sect:extrudedperiodic}

If an extruded periodic mesh is required then the periodic mesh must first
be derived from the \option{from\_file}\ mesh. The extruded mesh is then
derived from the periodic mesh. All other meshes are next derived from the
extruded mesh. A special case is the \option{CoordinateMesh}. This must be
derived from the extruded mesh by specifying
\option{periodic\_boundary\_conditions/remove\_periodicity}. At this stage it
is necessary to re-specify the \option{physical\_boundary\_ids},
\option{aliased\_boundary\_ids} and \option{coordinate\_map}. Additionally, the
\option{inverse\_coordinate\_map}\ must be given. As the name suggests, this
function must be the inverse of the original \option{coordinate\_map}.


\section{Material/Phase}
The final compulsory element in the top level of the options tree is
\option{/material\_phase}.  A \option{/material\_phase} element groups all
of the fields which pertain to one phase or one material. See
section~\ref{sec:config_multimatph} for an explanation of the distinction
between a phase and material in this context.

When configuring ocean problems (or single material/single phase fluids
problems), only one \option{/material\_phase} is required.  Multi-material
and multi-phase problems will require one \option{/material\_phase} for each
phase or material in the problem.

Note that you must give each of your material phases a name.

% NOTE: if you add anything below the Sediments sections here, change the ref...
The following sections (\ref{config:spatial} to \ref{config:sediments}) describe the options below the
\option{/material\_phase} option.

\section{Fields}
\index{field}
\subsection{Types of field}

A field associates a value with every node in the domain. Examples of fields
in a fluids simulation include the velocity and pressure. Fields in \fluidity\
are distinguished by the rank of the data on the field and the way in which
that field is calculated. 

\begin{description}
\item[Scalar fields] have a scalar value at each node. Common examples
  include temperature, pressure and density.
\item[Vector fields] have a vector value, in other words a list of numbers,
  at each node. The rank of a vector field is 1 and the length of the
  vector is given by the dimension of the problem.
\item[Tensor fields] have a value given by a square matrix at each
  node. The side length of the matrix is the problem dimension and the rank
  is naturally 2. The diffusivity of a tracer is a typical example of a
  tensor-valued field.
\end{description}

Fields can also be characterised by the manner in which their value is
calculated. \fluidity\ recognises three such categories:

\begin{description}
\item[Prognostic fields] are the result of solving a partial differential
  equation. In a typical fluids simulation, the velocity and pressure are
  prognostic and are calculated by solving some variant of the Navier-Stokes
  equations. Similarly, tracers such as temperature and salinity are usually
  the result of solving an advection-diffusion equation. Prognostic fields
  typically have specified initial and boundary conditions and it will be
  necessary to specify spatial and temporal discretisation options. If an
  implicit timestepping scheme is in use (and it almost always is in
  \fluidity), it is also necessary to specify solver options. 
\item[Diagnostic fields] are calculated from other fields without solving a
  partial differential equation. A typical example is the CFL number which
  may be calculated from the timestep, the mesh spacing and the velocity
  field. 
\item[Prescribed fields] receive their values from sources external to
  \fluidity. This might be a constant or varying function specified by the
  user, or it might be interpolated from some external data set. Fields such
  as diffusivity and viscosity are often prescribed as are source and
  absorption terms.
\end{description}

An additional field type - aliased - is also available.  This links the values in one field to those in another, using no extra computational resources during the simulation (i.e. it is not an independent field).  This is useful when sharing fields between material\_phases.  For example if two material\_phases share a common velocity field then only one should contain a prognostic field while the other is aliased to the other material\_phase.

\subsection{Setting field values}\label{Sect:setting_field_values}
\index{field!values}
\index{initial conditions!setting}
Field values must be specified by the user in two circumstances: the initial
value of most prognostic fields and the value throughout the simulation of
all prescribed fields. 

The initial value of prognostic fields is set with the
\option{\ldots/prognostic/initial\_condition} option while the value of
prescribed fields is set with the \option{\ldots/prescribed/value} option.


\subsubsection{Constant fields}
\index{field!constant}
Fields which are constant in space and (for prescribed fields) time may be
specified by simply providing a constant value in the \option{constant}
option under \option{\ldots/prognostic/initial\_condition},
\option{\ldots/prescribed/value}. For a scalar field, this is a single
floating point (real) value while for a vector field this is a list of reals
of length equal to the field dimension.

For tensor valued fields there are more options. It is possible to specify
an isotropic, or rotation invariant, value by choosing
\option{\ldots/value/isotropic/constant} and specifying a single real which
will be used for all the diagonal entries of the tensor field at all mesh
nodes. The off-diagonal entries of an isotropic tensor field are always
zero. A constant anisotropic field may be specified by choosing
\option{\ldots/value/anisotropic\_asymmetric/constant} and providing the
entire matrix. Finally, a constant symmetric anisotropic tensor field may be
specified by selecting \onlypdf\linebreak
\option{\ldots/value/anisotropic\_symmetric/constant}. In this case, the
user must specify all of the entries in the upper half of the matrix and
those in the lower half will be filled automatically by symmetry.

\subsubsection{Setting fields with a Python function}\label{Sect:setting_with_python}
\index{field!Python function}
\index{Python!prescribed field values}
The value of a field which varies in space and (for prescribed fields) in
time may be specified by providing an appropriate function written in
Python. The Python function will be evaluated for each node in the mesh at
the start of the simulation to populate the field values. For time-varying
prescribed fields, the function will be evaluated again at the beginning of
every timestep to update the field value. If it is known that the value of
the field does not in fact vary in time, then the re-evaluation of the
Python function on each timestep can be inhibited by setting the
\onlypdf\linebreak \option{\ldots/prescribed/do\_not\_recalculate} option.

The Python function must be provided as the value of the
\option{\ldots/python} option which may be chosen as an alternative to the
\option{\ldots/constant} function. The option may contain any Python code
but it must define a function \lstinline[language=Python]+val(X,t)+ where
the sequence \lstinline[language=Python]+X+ is the coordinates of the point
at which the field is being evaluated and \lstinline[language=Python]+t+ is
the current time. 

For a scalar field, the function must return a single floating point
value. Similarly for a vector field, a sequence of values of length equal to
the field dimension must be returned. For a tensor field, there are two
cases. For an isotropic field specified with
\option{\ldots/value/isotropic/python}, the function must return a single
float which will be used for all the diagonal entries of the tensor at that
point. The off-diagonal entries will be set to zero. For the anisotropic case,
the function must return a two-dimensional array (a sequence of
sequences). It is the user's responsibility to ensure that the tensor is
symmetric in cases where it should be.

\begin{example}
  \begin{lstlisting}[language=Python]
def val(X,t):
    return (-X[1],X[0])
  \end{lstlisting}
  \caption{A Python function returning a two-dimensional solid rotating
    vector field about the origin.}
\end{example}

\subsubsection{Reading fields from a file}
\index{field!input}
A field can be populated using saved data from a file. This is intended primarily
for picking up prescribed fields from previously run prognostic simulations
(checkpointing) and may be specified by providing the file name in
the \option{from\_file} option under \option{\ldots/prognostic/initial\_condition},
\option{\ldots/prescribed/value}.

For prescribed fields the format of the input file containing field data must be
vtu, and this will only work for those prescribed fields directly underneath
\option{\ldots/material\_phase}. For prognostic fields it is possible to select
the type of input file, under \option{\ldots/initial\_condition/from\_file/format};
the available supported formats for this include \option{vtu} and \option{NetCDF-CF 1.x}.

The file mesh must match the mesh of this field (except for piecewise constant
fields which will be remapped back from the discontinuous nodal values). In
parallel the process number is appended to the filename, e.g. if the file name
attribute is set to \option{input.vtu}, process 0 reads from \option{input-0.vtu}.

\subsubsection{Setting fields from NEMO data}\label{Sect:setting_from_nemo}
\index{field!from Nemo}
Initial conditions of prognostic fields and the values of prescribed fields can also be set from an external NEMO
data file. The external data file is in the NETCDF format and data is currently available for pressure, temperature, salinity
and velocity. To set the initial condition of a prognostic field from NEMO data, chose the option 
\option{\ldots/prognostic/initial\_condition/NEMO\_data} and then under \option{format} select the required data format. For scalar fields
the formats available are `Temperature', `Salinity' and `Free-surface height', for vector fields `Velocity' is the only available format.
Setting the value of prescribed fields from NEMO data works similarly. Set the option \option{\ldots/prescribed/value/NEMO\_data} and then proceed as above.

\subsection{Region IDs}
\index{region ID}
If the input mesh defines a number of region IDs then these may be employed
to specify different field values for each region. For a prescribed field,
this is achieved by changing the \option{\ldots/value::WholeMesh} element to
the unnamed \option{\ldots/value}. The user must then specify a new name for
that value element. Next, enable the  \option{\ldots/value/region\_ids}
option and set it to a list of region ids to which this value should
apply. Any number of  \option{\ldots/value} elements may be added to allow
different values to be specified in different regions. For prognostic
fields, analogous behaviour for initial conditions may be achieved by
switching \option{\ldots/initial\_condition} from \option{WholeMesh} to a
user-specified name and specifying the region IDs appropriately.

See section \ref{sect:region_ids}\ for information on including region IDs
in meshes.

\subsection{Mathematical constraints on initial conditions}\label{Sect:ICs}

For well-posedness, the initial condition of the velocity field must
satisfy both continuity (\ref{conty}) and the boundary conditions
imposed on the problem. If the normal component of velocity is
imposed on the entire boundary then the additional
compatibility constraint of global mass conservation must be
satisfied:
\begin{equation*}
\int_{\partial\Omega}\bmn\cdot\bmu=0.
\end{equation*}

\section{Advected quantities: momentum and tracers}
\label{config:spatial}

\subsection{Spatial discretisations}\label{Sect:Spatial discretisations}
\index{advection-diffusion equation!discretisation options}
\index{momentum equation!discretisation options}

A number of underlying finite element schemes are available for tracer
fields and velocity. In each case there are restrictions on the mesh
continuity which must be employed. In addition, the \onlypdf\linebreak
\option{conservative\_advection} option is applicable to all discretisation
types. See chapter \ref{chap:numerical_discretisation} for details.

For each field, the spatial discretisations can be selcted using
\option{\ldots/prognostic/spatial\_discretisation}.  Once selected a number
of other options will open underneath this option.

\subsubsection{Continuous Galerkin}
\label{sect:configuring_fluidity_continuous_galerkin}

Continuous Galerkin (CG) implements the CG scheme detailed in \ref{sec:balancing_diffusion}. If stabilisation methods are needed, the user can either select streamline upwind or streamline upwind Petrov-Galerkin. Other options include integration of advection by part, lumping of the mass matrix, or direct exclusion of both advection and mass terms.

\subsubsection{Control Volumes}\label{Sect:CVs}

The control volume options (\option{control\_volumes}) implements the advection scheme described in section \ref{ControlVolumeAdvection}. There are 
several options to control the face value and how diffusion is implemented.

The face value (\option{face\_value}) can be set to one of:
\begin{description}
\item[FirstOrderUpwind] - see section \ref{sec:cv_fou}.  Note that first order upwinding does not require nonlinear advection iterations as the low order pivot solution uses first order upwinding itself.  However in this case it is necessary that the implictness factor, $\theta$, is the same as the pivot implicitness factor, $\theta_p$ (see sections \ref{sec:cvtemp} and \ref{sect:configuring_fluidity_temporal_discretisation}).
\item[Trapezoidal] - see section \ref{sec:trap}, should be used with the suboptions describing a face value limiter (see section \ref{sec:cvlimiting}) active
\item[FiniteElement] - see section \ref{sec:cvfe}, should be used with the suboptions describing a face value limiter (see section \ref{sec:cvlimiting}) active
\item[FirstOrderDownwinding] - see section \ref{sec:fod}, intended for demonstration purposes only, not recommended for general use (unconditionally unstable)
\item[HyperC] - see section \ref{sec:hyperc}
\item[UltraC] - see section \ref{sec:ultrac}
\item[PotentialUltraC] - see section \ref{sec:potultrac}
\item[None] - turns off the advective terms
\end{description}

For the diffusion scheme (\option{diffusion\_scheme}) one can choose either:
\begin{description}
\item[ElementGradient] - see section \ref{sec:cvegdiff}
\item[BassiRebay] - works in two configurations equal order field and diffusivity or, for fields on a linear parent mesh, with a piecewise constant (element centred) diffusivity (staggered finite volumes), see section \ref{sec:cvbrdiff}
\end{description}

For steady state problems the mass terms may be disabled using \option{\ldots/mass\_terms/exclude\_mass\_terms}.  Note that this also requires the suitable setting of the temporal discretisation options ($\theta=1$).

\subsubsection{Coupled CV}\label{Sect:CoupledCVs}

The coupled CV options (\option{coupled\_cv}) implement another control volume discretisation with face value limits enforced in such a way to give boundedness both in the field and across the sums of fields.  Section \ref{sec:coupledlimiter} contains more details on this method.

Options must be selected to describe the face value scheme, which include most of the algorithms described in section \ref{Sect:CVs}.  Additionally it is necessary to prescribe the maximum and minimum bounds on the sum of this and the previous fields.  Because the coupled scheme depends on a priority ordering a priority (outside of the spatial discretisation options at \option{\ldots/scalar\_field/prognostic/priority}) must also be set with higher values having the highest priority and lower values the lowest.

Related fields to be used together during coupled limiting are grouped together based on their names from succesive material\_phases.  For example, if a field called MaterialVolumeFraction has coupled\_cv options then all other fields in all other material\_phases called MaterialVolumeFraction using coupled\_cv options will be advected together in order of their priority.  Spatial discretisation options within coupled\_cv may vary between the fields but temporal discretisation options must be identical.

\subsubsection{Discontinuous Galerkin method for the
  advection-diffusion equation}

The Discontinuous Galerkin option implements the advection-diffusion
algorithm described in Section
\ref{Sect:ND_discontinuous_galerkin_advection}. There are two
compulsory options to set, as well as a number of non-compulsory options.

\paragraph{Advection scheme (\option{advection\_scheme})} This
\emph{compulsory option} selects the approximation for the flux of
scalar across a face. Select one from:
\begin{itemize}
\item \option{upwind}: Use the upwind flux as described in Section
  \ref{Sect:ND_discontinuous_galerkin_advection}. This is the
  \emph{recommended flux} for DG advection.
\item \option{lax\_friedrichs}: Use the Lax-Friedrichs flux as described in
  Section \ref{Sect:ND_discontinuous_galerkin_advection}. This is an
  attempt to produce a bounded flux when the advecting velocity is
  discontinuous. This option is only for testing, if you have a
  discontinuous advecting velocity it is recommended to use the upwind
  flux combined with the option to project the velocity to a
  continuous space described below.
\item \option{none}: This option switches off the advection term completely.
\end{itemize}

\option{project\_velocity\_to\_continuous} \\
\option{integrate\_advection\_by\_parts} \\
\option{integrate\_conservation\_term\_by\_parts} 

\paragraph{Diffusion scheme (\option{diffusion\_scheme})} 
This \emph{compulsory option} selects the discretisation method used
for the diffusivity term. This selection is important for performance
since various different options have different stencil sizes, which
affects memory signature and hence the number of elements you can use
per processor.

Select one from:
\begin{itemize}
\item \option{bassi\_rebay}: The classical scheme of Bassi and Rebay (see
  section \ref{BassiRebay}). This scheme results in a large stencil
  for the diffusion matrix, which can reduce computational speed and
  increase memory use. If possible one should use a different option
  with a smaller stencil.
\item \option{compact\_discontinuous\_galerkin}: The compact
  discontinuous Galerkin scheme (CDG) from Peraire and Persson
  \citep{peraire2008} (see section \ref{CDG}). This scheme has the
  smallest stencil of any diffusion scheme and hence is the most
  efficient and uses the least memory resource. \emph{Recommended
    option}.

  Optionally, it is possible to set the
  \option{penalty\_parameter}.\index{penalty parameter!CDG} This
  optional option adds an extra term which penalises jumps across
  faces. You must supply a multiplicative constant which is scale
  independent (typical value is 10). This term is required to prove
  theoretical results about the CDG scheme, but we experimentally
  observe that it is not necessary, and hence, it is \emph{recommended
    not to use this option}.
\item \option{interior\_penalty}: Symmetric interior penalty (IP)
  scheme. This scheme simply integrates the diffusion operator by
  parts in each element, averages the fluxes and adds a term which
  penalises jumps. You must set the \option{penalty\_parameter}
  \index{penalty parameter!interior penalty method} which sets the
  multiplicative constant, and the \option{edge\_length\_parameter}.
  which specifies the scaling with the edge-length $h$. You must also
  select an \option{edge\_length\_option} which is either
  \option{use\_face\_integral} which computes a length scale from the
  face integral, or \option{use\_element\_centres} which uses the
  distance between centres of the two elements on either side of the
  face. Both of these options only function well for nearly isotropic
  meshes and hence CDG is the recommended diffusion choice since it 
  is compact and requires no such parameters.
\end{itemize}

\paragraph{Slope limiter (\option{slope\_limiter})}
Need to mention about subcycling.
\paragraph{Mass terms (\option{mass\_terms})}

\subsubsection{Conservative advection}

The momentum equation can be discretised conservatively by setting the
BETA factor equal to 1 (corresponding to a divergence form of the
equation). If BETA is set to zero, the discretisation is left
non-conservative. An intermediate value can alternatively be
selected. Please refer to section \ref{Sect:ND_momentum_equation} for a comprehensive discussion on the influence of this parameter.


\subsection{Temporal discretisations}
\label{sect:configuring_fluidity_temporal_discretisation}
Under temporal discretisation, you can set the value of theta, where $0$ is explicit, $0.5$ is Crank-Nicolson and $1$ is implicit. For scalar fields, the control volumes option may be selected if you are using control volumes or coupled cv spatial discretisation.  It contains options to set up nonlinear advection iterations, subcycling and the value of the pivot implicitness factor (see section \ref{sec:cvtemp}). The discontinuous galerkin option can be used if you are using discontinuous galerkin spatial discretisation to set the maximum courant number per subcycle, or the number of subcyles. 

\subsection{Source and absorption terms}\label{Sect:Source}
\index{source term}
\index{absorption term}

The source and absorption terms allow for external forcing of the tracer and
momentum equations. The source is a rate of change of the tracer which is
independent of the system state while the absorption term is linear in the
tracer. The source and absorption terms modify the tracer
equation as follows (cf. \eqref{eq:general_scalar_eqn}):
\begin{equation}
  \frac{\partial c}{\partial t} = F(c,u,t) - \sigma c + F,
\end{equation}
where $F(c,u,t)$ represents the advection and diffusion terms, $\sigma$ is the
absorption and $F$ is the source. The source and absorption are usually
prescribed fields supplied by the user but in some cases it may be necessary
to provide a diagnostic field which will be set by a parameterisation
somewhere in the model. If this is the case then this will be specified in
the documentation of that parameterisation.

For tracer fields, the source and absorption are specified by the\onlypdf\\
\option{\ldots/scalar\_field/prognostic/scalar\_field::Source} and\onlypdf\\
\option{\ldots/scalar\_field/prognostic/scalar\_field::Absorption} options
respectively. For velocity, the corresponding fields are naturally
vector-valued and are set by options\onlypdf\linebreak
\option{\ldots/vector\_field::Velocity/prognostic/vector\_field::Source} and\onlypdf\\
\option{\ldots/vector\_field::Velocity/prognostic/vector\_field::Absorption}
respectively.

\subsection{Sponge regions}\label{Sect:Sponge}
\index{sponge regions}
It is often useful to be able to relax momentum or a field variable to a
given state in regions of the domain, typically in regions close to
boundaries. This may be done using a combination of source and absorption
terms. If $F$ is the value of the source at a point and $\sigma$ is the
absorption, then the value of the scalar field $c$ will tend to relax to a value
of $F/\sigma$. The absorption, $\sigma$, has units $1/\mathrm{time}$ and controls the
time over which the relaxation occurs.

\section{Solving for pressure}
\index{pressure!options}
\label{sect:configuring_fluidity_pressure}

\subsection{Geostrophic pressure solvers}
\index{pressure!geostrophic balance}
\label{Sect:config_geostrophic_balance}

\subsection{First guess for poisson pressure equation} \label{sect:poisson_pressure_solution}
\fluidity's solution procedure for velocity and pressure can use a pressure poisson guess to speed up the convergence. In order to use a pressure guess, set \option{\ldots/scalar\_field::Pressure/prognostic/scheme/poisson\_pressure\_solution} from \option{never} to \option{only\_first\_timestep}.


\subsection{Removing the null space of the pressure gradient operator} \label{Nullspaceremove}
\index{pressure!null space}

If the normal component of velocity is imposed on all boundaries then the
appropriate boundary condition for pressure 
\citep[see][]{gresho87} is obtained by taking the normal component of
(\ref{mtm}), this yielding a Neumann boundary condition for
pressure. This only serves to define the pressure field up to an
arbitrary additive constant.

There are two different and mutually exclusive options which may be used to
fix the additive constant in the pressure field. The first is that the
pressure at a single point may be set to 0. This is achieved by setting the
\option{\ldots/scalar\_field::Pressure/prognostic/reference\_node} option. The
value of the option is the number of a node at which the pressure is to be
constrained to be zero. It is an error for the node number specified here to
be greater than the number of nodes in the simulation.

The second method is to instruct the linear solver to remove the null space
of the pressure equation as a part of the solution procedure. This is
achieved by enabling the\linebreak
\option{\ldots/scalar\_field::Pressure/prognostic/solver/remove\_null\_space}
option. This approach often leads to better convergence rates than setting
the \option{reference\_node}.

If however there is a single location on the boundary where the normal
component of velocity is not specified then there is no free constant in the
pressure and neither \option{\ldots/reference\_node} nor
\option{\ldots/remove\_null\_space} should be set. An example
may be stress free outflow or the presence of a free surface.

\section{Solution of linear systems}\label{Sect:Solve}
\index{linear solvers!options}

\subsection{Iterative Method}
\index{GMRES}
\index{conjugate gradient}
\index{multigrid}
\index{PETSc}
As described in Section \ref{ND_Linear_solvers}, for the solution of large sparse linear systems, the so called iterative methods are usually employed. These methods avoid having to explicitly construct the inverse of the matrix, which is generally dense and therefore costly to compute (both in memory and computer time). FLUIDITY is linked to PETSc: a suite of data structures and routines for the scalable (parallel) solution of scientific applications modeled by partial differential equations.  It employs the MPI standard for parallelism. FLUIDITY therefore supports any iterative method provided by the PETSc library (http://www-unix.mcs.anl.gov/petsc/petsc-2/snapshots/petsc-dev/docs/manualpages/KSP/KSPType.html --- available methods may depend on the PETSc library installed on your system). Examples include Conjugate Gradient (CG), GMRES and FGMRES (Flexible GMRES). Some options are explicitly listed under \option{solver/iterative\_method}, for example CG: \option{solver/iterative\_method::cg}, whereas others can be selected entering the name of the chosen scheme in \option{solver/iterative\_method}.

\subsection{Preconditioner}
\index{linear solvers!preconditioners}

The requirement for a suitable preconditioner is described in Section \ref{ND_Preconditioners}. In a manner analogous to the selection of the iterative method, some common preconditioning options are explicitly listed under \option{solver/preconditioner}, for example MG: \option{solver/preconditioner::mg}, whereas others can be selected by entering the name of the chosen scheme in \option{solver/preconditioner}. 

\subsubsection{Direct Solve}

Note that the option to solve a system exactly is available in FLUIDITY. For this, \option{solver/iterative\_method::preonly} must be selected (preonly: preconditioner only) and the preconditioner must be set to \option{solver/preconditioner::LU}. A full LU decomposition of the system is then carried out.

\subsection{Relative Error}
\index{linear solvers!convergence criteria}

The solver finishes if the preconditioned error becomes smaller than the original preconditioned error times this value. 

\subsection{Absolute Error}

The solver finishes if the preconditioned error becomes smaller than this value.

\subsection{Max Iterations}

The maximum number of iterations allowed for the linear solver before quitting.

\subsection{Start from Zero}

Switch on to start a solve with a zero vector and not a guess from a previous solve. Note that some solves always start at zero in which case this switch will have no effect (to check this, the user should refer to the log output). 

\subsection{Remove Null Space}

As documented in Section \ref{Nullspaceremove}, this option removes the null space.

\subsection{Solver Failures}
\index{errors!linear solver}

Three options are available here:

\begin{enumerate}
\item Never ignore solver failures: Solver failures are always treated as fatal errors. The model stops at the end of the time step in order to allow for the latest output to be written. 
\item Ignore non-convergence during spin-up: Allow for an initial period in which solver failures caused by non-convergence in the maximum number of iterations are ignored. 
\item Ignore all solver failures: Ignore all solver failures. This is a dangerous option that should only be used in exceptional cases. 
\end{enumerate}

It is recommended that users use the first option: Never ignore solver failures, however, on occasions (e.g. challenging initial conditions) the second might also be applicable. 

\subsection{Reordering RCM}

A bandwidth reduction algorithm --- reverse Cuthill-McKee reordering --- is used to improve cache performance.

\subsection{Solver Diagnostics}

This subsection includeds a series of extra diagnostic options to help debug solver problems. 

\subsubsection{Print norms}
Print out the norm of vectors and matrices before the solve, and that of the solution vector afterwards. Norms are printed at verbosity level 2, so run \fluidity\ with -v2 or -v3.

\subsubsection{Monitors}
Options to give extra information for each iteration of the the solve. Note that some of those may really slow down your computation. 


\section{Equation of State (EoS)}\label{Sect:ConfigEOS}
\index{equation of state!options}

The equation of state is a relation between state 
variables. For incompressible flows it is used to derive the density
from other variables such as temperature and salinity (cf. section \ref{Sect:IncompressibleFlow}). For compressible
flows it can be a more general relation between the state variables
including density and pressure.

The following EOS are available:

\begin{description}
\item\option{\ldots/equation\_of\_state/fluids/linear} 
Is a simple linear equation of state,
where density is a function of temperature and salinity.

\item\option{\ldots/equation\_of\_state/fluids/ocean\_pade\_approximation} Is a complex EOS for ocean modelling where density is a function of temperature, salinity and pressure.
\item\option{\ldots/equation\_of\_state/compressible/miegrunneisen} Is a simple compressible material EOS.
\end{description}

\subsubsection{Linear fluid EOS}
\index{equation of state!linear}
The density is a linear function of temperature and salinity:
\begin{equation}
  \rho=\rho_0 \left(1-\alpha(T-T_0)+\beta (S-S_0)\right),
\end{equation}
where $\rho_0, \alpha, T_0, \beta$ and $S_0$ are set by the following 
options:
\begin{description}
\item \option{\ldots/linear/reference\_density} sets $\rho_0$
\item \option{\ldots/linear/temperature\_dependency/thermal\_expansion\_coefficient} sets $\alpha$
\item \option{\ldots/linear/temperature\_dependency/reference\_temperature} sets $T_0$
\item \option{\ldots/linear/salinity\_dependency/salinity\_contraction\_coefficient} sets $\beta$
\item \option{\ldots/linear/salinity\_dependency/reference\_salinity} sets $S_0$
\end{description}
Note that for Boussinesq the reference density does not 
influence any of the terms in the 
momentum equation (see \eqref{boussinesq}). It may influence the outcome
of diagnostic fields depending on density.

The option \option{subtract\_out\_hydrostatic\_level} only changes 
the buoyancy term. For LinearMomentum it changes to 
$g(\rho-\rho_0)$ and does not affect the density in the $Du/Dt$ term. For
Boussinesq it changes to 
$g\rho'=g(\rho-\rho_0)/\rho_0$ (again see \eqref{boussinesq}), 
and this option should always be used.
In both cases the diagnostic
``Density'' field and all other diagnostic fields depending on density
still represent the full density.

\subsubsection{Pade ocean EOS}
\index{equation of state!Pade approximation}
This EOS is described in section~\ref{Sect:PadeDescription}.
This option uses mean hydrostatic pressure based on depth to calculate the
pressure (hence why you need to provide the value of z on the top surface).
For this option, the temp field represents potential temperature \emph{not} in
situ temperature - so beware (see \citet{mcdougall2003} for a formula for converting
from in-situ to potential). The units are degrees Centigrade for potential
temperature, \PSU{} for salt, \kgmm{} for density. The reference density is
\kgmm[1000] and the momentum equation is Boussinesq using this reference density.

\subsubsection{Compressible EOS}\label{Sect:Multi-material compressible EOS}
\index{equation of state!stiffened gas}
\option{\ldots/equation\_of\_state/compressible/miegrunneisen} defines a simple compressible equation of state that can be used to describe gases, liquids and solids, known as the stiffened gas EOS. %(see section~\ref{Sect:StiffenedGas}).

\begin{description}
\item\option{\ldots/miegrunneisen/reference\_density} Specifies the reference density of the material in SI units.
\item\option{\ldots/miegrunneisen/ratio\_specific\_heats} Specifies the ratio of specific heats of the gas minus 1 $(c_p/c_V-1)$ in the perfect gas EOS and the Gruneisen parameter in the stiffened gas equation of state. Not activating this option simplifies the compressible EOS to that of a compressible liquid.
\item\option{\ldots/miegrunneisen/bulk\_sound\_speed\_squared} Specifies the bulk sound speed squared for the material $c_B^2$. Not activating this option simplifies the compressible EOS to that of a perfect gas.
\end{description}

\section{Subgridscale Parameterisations}

\fluidity\ contains a number of subgridscale parameterisations which model physical process below the resolution of the mesh.

\subsection{GLS}

This option enables the model described in section \ref{Sect:GLS}. There are a few different 
sub-options to configure. First, you must choose which GLS method to use 
from $k-\epsilon$, $k-kl$, $k-\omega$ and $gen$. Next, the stability functions
can be chosen. CanutoA or CanutoB are recommended. If you are running a 3D model, then switching on  
\option{\ldots/calculate\_boundaries} is recommended in order for the boundary conditions to be set correctly. 
Finally, you can enable a number of optional diagnostic fields.

The user can also choose to relax the diffusivity and viscosity calculated by switching on the\linebreak
\option{\ldots/relax\_diffusivity}. The value specified must be between 0 and 1.0. A value of 0 indicates
no relaxation, 1.0 would indicate no changes to be made. If this option is activated, the diagnostic fields
\option{GLSTurbulentVerticalDiffusivity} and \option{GLSTurbulentVerticalViscosity} must also
be activated. In addition, if adaptivity is enabled, these two fields must have an interpolation
method set, e.g. \option{\ldots/GLSVerticalViscosity/diagnostic/consistent\_interpolation}.

For each field that will be effected by the subgrid scale parameterisations, 
you must enable the correct diffusivity. This
is done by specifying \option{\ldots/subgridscale\_parameterisation} in the
field to \option{GLS}. Normally, this would be the temperature, salinity and any biology fields active.

Finally, fields that are altered by the GLS model, such as the Viscosity, need to be switched
to a \option{diagnostic/algorithm::Internal}. The list of fields to switch is:
\begin{enumerate}
\item \option{GLSTurbulentKineticEnergy/Diffusivity}
\item \option{GLSTurbulentKineticEnergy/Source}
\item \option{GLSTurbulentKineticEnergy/Absorption}
\item \option{GLSGenericSecondQuantity/Diffusivity}
\item \option{GLSGenericSecondQuantity/Source}
\item \option{GLSGenericSecondQuantity/Absorption}
\item \option{Velocity/Viscosity}
\end{enumerate}

If these fields are not set correctly, a user error will occur.

\subsection{k-$\epsilon$ Turbulence Model}\label{Sect:kepsilon_usage}
\index{turbulence model}
\index{k-$\epsilon$ model}

This option enables the turbulence model described in \ref{Sect:kepsilon}. It must not be confused with the
$k-\epsilon$ option in the GLS model (see \ref{Sect:GLS}) which is only for oceans like problems.
The user must select either implicit or explicit source and absorption terms via \option{\ldots/option}.
If \option{explicit} is chosen, the source and absorption terms are as described in \ref{Sect:kepsilon}.
If \option{implicit} is chosen, the source and absorption terms are calculated as follows:
\begin{align*}
\textrm{source} &= -\min(0.0, \textrm{diss}-\textrm{prod}), \\
\textrm{absorption} &= max(0.0, \textrm{diss}-\textrm{prod}), 
\end{align*}
where `$\textrm{source}$' is the explicitly calculated source term and `$\textrm{absorption}$' is the explicitly calculated absorption term. 

In \fluidity\ the $k$ field is called \option{TurbulentKineticEnergy} and the $\epsilon$ field \option{TurbulentDissipation}.
The model works well with the following spatial discretisation options for $k$ and $\epsilon$: \linebreak
\option{\ldots/control\_volumes/face\_value::FiniteElement/limit\_face\_value/limiter::Sweby} \linebreak
with \option{/control\_volumes/diffusion\_scheme::ElementGradient}.
This discretisation is significantly speeded up by selecting
\option{/project\_upwind\_value\_from\_point/} \linebreak
\option{store\_upwind\_elements\_store\_upwind\_quadrature}.

Fully implicit or Crank-Nicolson temporal discretisation is recommended.
If using the above spatial discretisation the
\option{control\_volume} discretisation option should be selected, with \linebreak
\option{number\_advection\_iterations} = 3.

Fields that are altered by the k-epsilon model need to be switched
to \linebreak \option{diagnostic/algorithm::Internal}. The list of fields to switch is:
\begin{enumerate}
\item \option{Velocity/Viscosity}
\item \option{TurbulentKineticEnergy/Diffusivity}
\item \option{TurbulentKineticEnergy/Source}
\item \option{TurbulentKineticEnergy/Absorption}
\item \option{TurbulentDissipation/Diffusivity}
\item \option{TurbulentDissipation/Source}
\item \option{TurbulentDissipation/Absorption}
\end{enumerate}

If these fields are not set correctly, a user error will occur. The eddy viscosity is available as a diagnostic
tensor field and as a diagnostic scalar field. However, the molecular (or laminar) viscosity must still be prescribed under \linebreak
\option{\ldots/k-epsilon/tensor\_field::BackgroundViscosity}.

If using additional scalar fields such as temperature, salinity etc, an option is available under \linebreak
\option{\ldots/subgridscale\_parameterisation::k-epsilon} to use the eddy diffusivity scaled by a user-specified Prandtl number.

Three optional diagnostic scalar fields are available within the model: LengthScale, TKEOverEpsilon and EpsilonOverTKE. The first is the integral length scale of the turbulence (see \eqref{lengthscale}), the second is the ratio of the $k$ and $\epsilon$ fields, and the third is it the reciprocal, also known as omega or the specific dissipation.

\subsubsection{Initial and Boundary Conditions}

The model is sensitive to the initial conditions specified for the $k$ and $\epsilon$ fields. It is recommended to use the special boundary condition type, \option{\ldots/k\_epsilon} on any surface of interest for these fields. Different wall functions are available for low- and high-Reynolds-number flows. The cutoff between high and low Reynolds number is at the user's discretion but is usually of order $10^4$.

In the low Reynolds number case, \eqref{epsbc1} are implemented by selecting \option{\ldots/boundary\_conditions/k\_epsilon/low\_Re}. In the high Reynolds number case, \eqref{kbc2} and \eqref{epsbc2} are implemented by selecting \option{\ldots/boundary\_conditions/k\_epsilon/high\_Re}. The velocity condition, \eqref{ubc2}, can be selected under \linebreak
\option{\ldots/Velocity/prognostic/boundary\_conditions/type::log\_law\_of\_wall}.
However, if using a sufficiently fine near-wall mesh, roughly the correct velocity profile can be obtained with a no-slip Dirichlet BC.

If using Dirichlet conditions, it is recommended that $k$ and $\epsilon$ be set to small values, chosen such that the eddy viscosity on the boundaries is of order $O(\nu)$ (background viscosity), and both fields perhaps of order $O(1/Re)$.

\section{Boundary conditions}\label{Sect:BCs_configure}
\index{boundary conditions}

The simulated system requires suitable boundary conditions for full closure.
An example could be the amount of sunlight at the ocean surface, a specified value of
temperature heating material from below, or a momentum stress in the form of wind for velocity.
It is also possible to leave boundary conditions undefined, in which case "stress-free" conditions are
applied. See section \ref{Sect:BCs} for further details.

\subsection{Adding a boundary condition}\label{Sect:BCs:adding}

Boundary conditions are set for each field contained in state under \option{\ldots/boundary\_conditions}. 
Multiple boundary conditions can be set for each field, such that the sides, surface and bottom can 
have different conditions. A boundary conditions is added by clicking the "+" symbol
in the appropriate field

\subsection{Selecting surfaces}\label{Sect:BCs:selecting}
\index{surface ID}
To each boundary condition a set of domain surfaces is assigned on which it is applied to. The surfaces are identified by a surface ID specified during the mesh generation procedure (see section \ref{sect:surface_ids}). For example if the top and bottom of your mesh is defined as surface
1, then simply add a 1 to \option{\ldots/boundary\_conditions/surface\_ids}. Multiple surfaces 
can be added, separated by a space.

\subsection{Boundary condition types}\label{Sect:BCs:types}
\index{boundary conditions!setting}
\fluidity\ supports a wide range of boundary coditions which will be introduced in the next sections.

\subsubsection{Dirichlet}
\index{boundary conditions!Dirichlet}

A Dirichlet condition sets the value of the field ($c$) at each location over the surface $\partial\Omega$:
\begin{equation*}
c(\bmx) = f(\bmx) \quad \textrm{on}\; \partial\Omega.
\end{equation*}

Dirichlet boundary conditions can also be applied weakly by selecting the \option{\ldots/apply\_weakly}
option. Unlike the strong form of the Dirichlet conditions, weak Dirichlet
conditions do not force the solution on the boundary to be pointwise equal
to the boundary condition. 

\subsubsection{Neumann}
\index{boundary conditions!Neumann}

A Neumann boundary condition sets the derivative to the normal ($\vec n$) of the surface $\partial\Omega$:
\begin{equation*}
\frac{\partial c}{\partial n} \left(\equiv \vec{n}\cdot\nabla c\right) = f(\bmx) \quad \textrm{on}\;  \partial\Omega.
\end{equation*}

\subsubsection{Bulk formulae}\label{Sect:bulk_formulae}

These boundary conditions can be used on:
\begin{itemize}
\item Salinity
\item Temperature
\item Velocity
\item PhotosyntheticRadiation
\end{itemize}

They use meteorological data and convert it into a Neumann or Dirichlet boundary condition
as appropriate for the fields above. You do not need to have all the above fields; only 
velocity and temperature are required. More information can be found in section \ref{Sect:BCs:special:oceans}.

\subsubsection{Zero flux}
\index{boundary conditions!zero flux}

For control volume discretisations only this options prevents the field fluxing from the boundary.

\subsubsection{Free surface}
\index{boundary conditions!free surface}
\index{free surface!boundary condition}

The \option{\ldots/free\_surface} option allows the height of upper surface to vary according
to the pressure and velocity fields. This boundary condition is available on the velocity field only. It is
recommended you activate a diagnostic Free Surface field also.

\subsubsection{Drag}
\index{boundary conditions!drag}

Applies a quadratic or linear drag to the Velocity field. Both the value and the type of drag need to be set. A Manning-Strickler drag can be used by activating \option{\ldots/quadratic\_drag/manning\_strickler}

\subsubsection{Wind forcing}\label{Sect:wind_forcing}
\index{boundary conditions!wind stress}
\index{wind forcing}

A wind forcing can be applied to the Velocity field as either a stress or
velocity. For stress values, the physical units should match those of the
simulation, so for example, if you use the non-dimensional value of $\rho$
as 1.0, your stresses (in \unit{kgm\ensuremath{^{-1}}s\ensuremath{^{-2}}})
should be divided by the reference density.  If using wind velocity
(at 10m height) the density of the air needs to be specified in the same
units, i.e. $\rho_{\textrm{air}} = 1.3\times10^{-3}$.

Alternatively
\option{\ldots/Velocity/boundary\_conditions/wind\_forcing/wind\_stress}
sets the value of wind forcing from a NETCDF file. The NETCDF file must
contain East-West and North-South components, along with times locations
(latitude/longitude) for the values. In addition, one must set
\option{/timestepping/current\_time/time\_units} in order for the simulated
time to be matched to the NETCDF data.

\subsubsection{No normal flow}
\index{boundary conditions!no normal flow}

When using \option{\ldots/control\_volumes} under Pressure \option{\ldots/spatial\_discretisation} or when using 
\option{\ldots/integrate\_continuity\_by\_parts} with CG Pressure and Velocity this boundary condition type 
imposes a weak no normal flow boundary condition on the surfaces specified.

\subsubsection{Near-wall treatment}

This option implements a penalty function for the near wall region, negating the need to use fine meshes
near walls \citet{bazilevs2007}. This option should be used in conjunction with a 
\option{\ldots/no\_normal\_flow} boundary on the same surface.

\subsubsection{Log-law of wall}

This option sets the velocity to proportional to the logarithm of the distance from the boundary. 
A surface roughness needs to be specified which is the thickness of laminar sublayer.

\subsection{Special input date for boundary conditions}\label{Sect:BCs:specialised}

When running free surface simulations the surface elevation at the boundary is specified by applying a pressure Dirichlet condition. Since the free surface elevation is often measured data, there are some special possibilities to specify a pressure Dirichlet condition: 

\option{\ldots/from\_file} allows the specification of a single file
containing something useful. This option is available on the Pressure (Free
Surface) field. Tidal boundary conditions can be applied by setting this option
and referencing a relevant NetCDF file containing appropriate amplitude and phase data for the desired
tidal constituent(s). The file is referenced under:
\begin{itemize}
\item \option{\ldots/tidal/file\_name},
\end{itemize}
with the amplitude and phase names (as specified in the NetCDF file) set under:
\begin{itemize}
\item \option{\ldots/tidal/variable\_name\_amplitude},
\item \option{\ldots/tidal/variable\_name\_phase}
\end{itemize}
respectively. Finally, the constituet should be selected from the list under:
\begin{itemize}
\item \option{\ldots/tidal/name}.
\end{itemize}
A separate tidal boundary consition needs to be set for each constituent.

\index{boundary conditions!NEMO data}
\option{\ldots/NEMO\_data} will set the field according to a specified NEMO
input file. This option is available for the Pressure (Free Surface) field.
In order to use this option a prescribed field containing NEMO pressure
field data must first be created. See section \ref{Sect:setting_from_nemo}
for information on setting prescribed fields from NEMO data. Then, under
\option{\ldots/NEMO\_data/field\_name}, set the string to that of the prescribed
field containing the NEMO pressure data to enable this option.

%\option{\ldots/synthetic\_eddy\_method} does stuff. Available for velocity.

\subsection{Special cases}\label{Sect:BCs:special}

There are a few special cases of boundary conditions that are not applied
using the methods described above.  These include ocean surface forcing and
the boundary conditions on the General Length Scale (GLS) turbulence model.

\subsubsection{Ocean surface forcing}\label{Sect:BCs:special:oceans}
\index{boundary conditions!ocean}

Ocean surface forcing takes parameters from ERA40 datasets, passes them
through bulk formulae and gives a boundary condition for the salinity,
temperature, photosynthetic radiation and velocity fields. The settings for
these options are in \option{/ocean\_forcing/bulk\_formulae}. However, you must also set up
\option{/timestepping/current\_time/time\_units}.

Under \option{/ocean\_forcing/bulk\_formulae} an input file must be defined. The fields on 
which bulk formulae are to be imposed should have their upper surface set to the correct
boundary condition type (\option{bulk\_formulae}).
The input file must contain the following ERA40 parameters for the
duration of the simulated time:
\begin{itemize}
 \item 10 metre U wind component (\ms)
 \item 10 metre V wind component (\ms)
 \item \m[2] temperature (\K)
 \item Surface solar radiation downward (\unit{Wm\ensuremath{^{-2}}s})
 \item Surface thermal radiation downward (\unit{Wm\ensuremath{^{-2}}s})
 \item Total precipitation (\unit{ms})
 \item Run off (\unit{ms})
 \item \m[2] dew point temperature (\K)
 \item Mean sea-level pressure (\Pa)
\end{itemize}

These variables are surface variables as defined by data files from the ERA40 website. Note that some parameters are accumulated values
and as such are required to be divided by the ERA40 temporal resolution - \fluidity { } assumes 6 hour temporal resolution. 
These parameters are used as input to the default bulk forcing formulae of \citet{large2004} included in \fluidity. Other
formulae are available: COARE 3.0 \citep{fairall2003} and those of \citet{kara2005} which are based on the COARE data.

Other options under ocean surface forcing include specifying a latitude and longitude, and using a single position for the
forcing data. These options are only really useful when simulating pseudo-1D columns (see the gls-StationPapa test for an example
of a pseudo-1D column). Enabling the \option{position} option allows the user to specify a latitude and longitude as
two real numbers (e.g. 50.0 -145.0 for 50$^\circ$ N and 145$^\circ$ W). These co-ordinates are translated into cartesian
co-ordinates, which are then added to the positions of the surface of the mesh. This allows the use of simple mesh geometries
and co-ordinates, whilst still specifying where the forcing data should originate. Moreover, the \option{single\_location}
option forces \emph{all} surface nodes to receive the same forcing.

Finally, it is possible to output the fluxes that are imposed on the ocean surface, by enabling the
\option{output\_fluxes\_diagnostic} option. Here, the user can enable diagnostic fields for momentum, heat, salinity and
photosynthetic radiation downwards. The fluxes will then be included in the output as normal scalars or vectors, but with values
confied to the upper surface.

\subsubsection{GLS subgridscale parameterisation}\label{Sect:BCs:special:gls}
\index{generic length scale model!boundary conditions}
\index{boundary conditions!generic length scale model}

The GLS model (see section \ref{Sect:GLS}) requires that Neumann boundary
conditions are set for stability, however, the boundary conditions on the
Generic Second Quantity ($\Psi$) depend on other modelled variables. In
order for the boundary conditions to be set correctly, enable the \linebreak
\option{\ldots/subgridscale\_parameterisations/GLS/calculate\_boundaries}
option.

\subsubsection{k-epsilon subgridscale parameterisation}\label{Sect:BCs:special:kepsilon}
\index{k-$\epsilon$ model!boundary conditions}
\index{boundary conditions!k-$\epsilon$ model}

The k-epsilon turbulence model (see section \ref{Sect:kepsilon}) should apply zero Dirichlet boundary
conditions to the TurbulentKineticEnergy ($k$) field. The TurbulentDissipation ($\epsilon$) field
should use the special type of Dirichlet condition called \option{k\_epsilon} which is calculated in the
k-epsilon module. To enable calculation of the boundary conditions on both fields, set the \linebreak
\option{\ldots/subgridscale\_parameterisations/k-epsilon/calculate\_boundaries}
option.

\section{Astronomical tidal forcing}
\label{config:tides}
\index{tides}

Astronomical tidal forcing can be switched on for 11 different constituents
under:
\begin{itemize}
\item \option{/ocean\_forcing/tidal\_forcing}, 
\end{itemize}
(see \citealp{Wells2008} for descriptions of
the different constituents). These can be switched either
individually or in combination. In addition, a body tide correction can be stipluated
under:
\begin{itemize}
\item \option{\ldots/tidal\_forcing/love\_number},
\end{itemize}
for which the suggested value is 0.3 (assuming 
Love numbers of $k$=0.3 and $h$=0.61; see section \ref{astronomical}).   

Note that for many cases, specifically those involving open boundaries, it is often
desirable to combine astronomical tidal forcing with a co-oscillating boundary tide condition
(see section \ref{Sect:BCs:specialised}).

\section{Ocean biology}
\index{biology}

Enabling this turns on the ocean biology model. In addition you also need to add several scalar fields in the first material phase:
\begin{itemize}
\item Phytoplankton
\item Zooplankton
\item Nutrient
\item Detritus
\item Primary production
\end{itemize}

There are several items that need configuring before biology can be used.
First a relationship between sources and sinks needs encoding. This is best
done by importing fluidity.ocean\_biology into
\option{/ocean\_biology/pznd/source\_and\_sink\_algorithm} and calling the
models from there. An example is given below.

\begin{example}
  \begin{lstlisting}[language=Python]
import fluidity.ocean_biology as biology

day=1./(3600*24)

p={}
p["alpha"]=0.015*day
p["beta"]=0.75
p["gamma"]=0.5
p["g"]=1*day
p["k_N"]=0.5
p["k"]=0.5
p["mu_P"]=0.1*day
p["mu_Z"]=0.2*day
p["mu_D"]=0.05*day
p["p_P"]=0.75
p["v"]=1.5*day

biology.pznd(state, p)  
  \end{lstlisting}
  \caption{A Python function that imports the biology module and sets the algorithm to use.}
\end{example}

The final thing to change is to add absorption coefficients in the photsynthetic radiation field for water and plankton concentration.

\section{Sediment model}
\label{config:sediments}
\index{sediments}

\fluidity\ contains a basic sediment model in which sediment is treated as a
tracer with a settling velocity and the amount of sediment falling through
the bottom boundary is recorded. Enabling sediments creates two template
fields: one for sediment concetration in the fluid and one for the flux of
sediment over the bottom boundary. These can be found at
\option{\ldots/sediment/scalar\_field::SedimentTemplate} and
\option{\ldots/sediment/scalar\_field::SedimentFluxTemplate} respectively.
It is also possible to specify multiple sediment classes, each of which can
contain a different settling velocity and hence when coupled with the
density, represent different sediment grain sizes. At least one class must
be present.

The sediment classes can use either the template initial concentration or set their own.

Note: To use sediment, a linear equation of state must also be enabled \option{\ldots/equation\_of\_state/fluids/linear}

\section{Large scale low aspect ratio ocean simulations}
\label{section:large-scale-ocean}

This section contains advice for running a large scale ocean simulation with a large aspect ratio. This section is split into options that must be used and options that are recommended.

\subsection{Options that must be switched on}
These options are almost always recommended for large scale ocean problems.

\subsubsection{Meshes}

The mesh that you use must be a two plus one mesh which is unstructured in the horizontal and structured in the vertical.  It can either be constructed in gmsh and read into fludity, or a two-dimensional mesh can be made in gmsh and extruded within fluidity (see \ref{sect:extruded_meshes}). In addition, these mesh settings are recommended:
\begin{itemize}
\item The Velocity mesh must be discontinuous gelerkin polynomial order one, so set \\* \option{\ldots/geometry/mesh(VelocityMesh)/from\_mesh/mesh\_shape/mesh\_continuity} to discontinuous.  
\item The Pressure mesh must be of polynomial order two, so set 
\\* \option{\ldots/geometry/mesh(PressureMesh)/from\_mesh/mesh\_shape/polynomial\_degree}  to $2$.  
\item The temperature and salinity are solved on a continuous galerkin, polynomial order one mesh (no special mesh options).
\item Also under geometry, the \option{\ldots/geometry/ocean\_boundaries} option mush be switched on, with the surface id's specified.
\end{itemize}

\subsubsection{Time stepping}
\begin{itemize}
\item \option{\ldots/timestepping/nonlinear\_iterations} option must be more than $1$, normally $2$ is a good choice.
\item \option{\ldots/material\_phase/equation\_of\_state/subtract\_out\_hydrostatic\_level} must be on.
\end{itemize}

\subsubsection{Velocity options}
The velocity is discontinuous galerkin.  The required options are listed below.

\begin{itemize}
\item \option{\ldots/equation} must be set to Boussinesq
\item \option{\ldots/spatial\_discretisation} must be discotinuous galerkin
\item \option{\ldots/spatial\_discretisation/advection} is upwind
\item \option{\ldots/spatial\_discretisation/advestion/integrate\_advection\_by\_parts} is twice
\end{itemize}

\subsubsection{Advected scalar fields (temperature, salinity etc)}
The temperature and salinity are continuous galerkin. 

\begin{itemize}
\item \option{\ldots/spatial\_discretisation} must be Continuous Galerkin
\end{itemize}

\subsubsection{Pressure options}

This is continuous galerkin discretisation, with a mesh of polynomial order two (already specified above).

\begin{itemize}
\item \option{\ldots/spatial\_discretisation} must be Continuous Galerkin
\item \option{\ldots/solver/vertical\_lumping} must be on
\end{itemize}

\subsection{Recommended or optional settings}
These settings may be recommended, but this section is not intended to be a list of instructions.

\subsubsection{Meshes}

The quadrature degree is usually four in these cases.

\subsubsection{Velocity options}

\begin{itemize}
\item \option{\ldots/spatial\_discretisation/discontinuous\_galerkin/lump\_mass\_matrix} is \textbf{off}
\item \option{\ldots/spatial\_discretisation/viscosity\_scheme} can be Bassi Rebay or compact discontinuous galerkin
\item \option{\ldots/spatial\_discretisation/advection/conservative\_advection} is set to $0.0$
\item \option{\ldots/temporal\_discretisation/theta} is $0.5$ (Crank-Nicolson), or $1$ if the advection term is switched off (e.g. during spinning up)
\item \option{\ldots/temporal\_discretisation/conservative\_advection} is set to $0.0$
\item \option{\ldots/solvers} normally gmres - or cg if the advection term is switched off (e.g. during spinning up)
\item \option{\ldots/solvers/preconditioner} eisenstat - or try mg if using compact discontinuous galerkin vorticity
\end{itemize}


You might want to create a Viscosity field under Velocity and set it to the required value. 

An Absorption field may need to be added under Velocity to allow larger time steps to be taken, otherwise your time steps will be limited by the scale of the baroclinic waves.  This term should have a vertical component equal to  ${\frac{1}{\rho_0}} {\theta} {\Delta} {t} {g} {\frac{\partial \rho}{\partial z}}$ and the other components are zero. $\rho_0$ is the reference density, $\theta$ is the value set under \\* \option{\ldots/Velocity/temporal\_discretisation/theta}, ${\Delta} {t} $ is the timestep, $g$ is the acceleration due to gravity and $\frac{\partial \rho}{\partial z}$ is the background density stratification.  The absorption term can be a constant if the background stratification is constant. Otherwise, set it with a python function.  Also turn on the \\* \option{\ldots/Absorption/include\_pressure\_correction} option.

\subsubsection{Free Surface Field}
This can be added if required.  You should also select a free surface boundary condition under Velocity.

\subsubsection{Pressure options}
\begin{itemize}
\item \option{\ldots/spatial\_discretisation/remove\_stabilitation\_term} is switched on
\item \option{\ldots/spatial\_discretisation/integrate\_continuity\_by\_parts} is switched on
\item \option{\ldots/scheme/poisson\_pressure\_solution} is only first time step
\item \option{\ldots/scheme/use\_projection\_method} is  on
\item \option{\ldots/solver} is normally cg or gmres
\item \option{\ldots/solver/preconditioner} is normally mg
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%% GFD problems %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Geophysical fluid dynamics problems}

This section contains advice for running Geophysical Fluid Dynamics (GFD) problems, such as laboratory-scale flows e.g. the lock-exchange and the annulus or smaller-scale ocean problems e.g. a gravity current on an incline. This section is arranged by options for the different levels of the options tree. Both continuous-Galerkin (P1-P1) and discontinuous-Galerkin (P1DG-P2) discretisations may be used, chapter \ref{chap:numerical_discretisation}, and different options choices are distinguished where necessary.

\subsection{Problem type}

The \option{\ldots/problem\_type} option should be set to \option{fluids} or \option{ocean}.

\subsection{Geometry}
\label{sect:GFD_config_geometry}

For both P1-P1 and P1DG-P2 \option{\ldots/geometry/mesh::CoordinateMesh} is required. For P1-P1 this can then be used for both the velocity and pressure fields so \option{\ldots/geometry/mesh::VelocityMesh} and \option{\ldots/geometry/mesh::PressureMesh} do not need to be set.

For P1DG-P2 the velocity mesh requires discontinuous Galerkin to be selected for continuity and the pressure mesh must have polynomial order two. To do this set:
\begin{itemize}
\item \option{\ldots/geometry/mesh::VelocityMesh/from\_mesh/mesh::CoordinateMesh}
\item \option{\ldots/geometry/mesh::VelocityMesh/from\_mesh/mesh\_continuity} to \option{discontinuous}
\item \option{\ldots/geometry/mesh::PressureMesh/from\_mesh/mesh::CoordinateMesh}
\item \option{\ldots/geometry/mesh::PressureMesh/from\_mesh/mesh\_shape/polynomial\_degree} to 2
\end{itemize}

If \option{\ldots/scalar\_field::GeostrophicPressure} is to be included, cf. \ref{Sect:config_geostrophic_balance}, \ref{Sect:GFD_config_geopressure}, then a further mesh needs to be added. This must have polynomial degree one order greater than the mesh used for the velocity field. To demonstrate let us call this mesh `GeostrophicPressureMesh', derive this mesh from the \option{CoordinateMesh} and assume the mesh used for the velocity field has polynomial order 1, then to include this option:
\begin{itemize}
\item select a new \option{\ldots/geometry/mesh} and set the \option{name} attribute as \option{GeostrophicPressureMesh}
\item select \option{\ldots/from\_mesh::CoordinateMesh}
\item set \option{\ldots/from\_mesh::CoordinateMesh/mesh\_shape/polynomial\_degree} to 2
\end{itemize}

\subsection{Timestepping}

2 non-linear iterations are recommended and can be specified by setting \option{\ldots/timestepping/nonlinear\_iterations} to 2.

\subsection{Material/phase}


\subsubsection{Equation of state}

For most problems the linear equation of state is appropriate, cf. \ref{sect:equation_of_state}. This is selected with \option{\ldots/equation\_of\_state/fluids/linear} and other values such as the thermal contraction coefficient can be set in the options that appear below. 

It is generally recommended to subtract out the hydrostatic pressure level from the equation of state by setting the option \option{\ldots/equation\_of\_state/fluids/linear/subtract\_out\_hydrostatic\_level}. This will allow increased accuracy for lower-order element pairs, cf. \ref{Sect:balance_pressure}.

\subsubsection{Pressure}

The specified mesh should be \option{CoordinateMesh} for P1-P1 and \option{PressureMesh} for P1DG-P2. 

\begin{itemize}
\item \option{\ldots/spatial\_discretisation/continuous\_galerkin} is recommended for the spatial discretisation. 
\item \option{\ldots/scheme/poisson\_pressure\_solution} can be chosen as either \option{never} or \option{only\_first\_timestep}, cf. \ref{sect:poisson_pressure_solution}.
\end{itemize}

Note, if the normal component of the velocity is imposed on all boundaries, then either \option{\ldots/prognostic/reference\_node} or \option{\ldots/solver/remove\_null\_space} need to be set, cf. \ref{Nullspaceremove}.

\subsubsection{Velocity}

The specified mesh should be \option{CoordinateMesh} for P1-P1 and \option{PressureMesh} for P1DG-P2. 

The equation used to solve for Velocity is set under \option{\ldots/equation}, cf. \ref{Sect:ND_momentum_equation}. For GFD problems that require the Boussinesq approximation selecting \option{\ldots/equation::Boussinesq} will ensure that this correct formulation used, cf, \ref{sect:boussinesq_approximation}, \ref{sect:typical_ICOM_equations}, \ref{Sect:ND_momentum_equation}.

A Crank-Nicolson temporal discretisation with a non-linear relaxation is recommended for the temporal discretisation cf. \ref{sect:ND_time_loop}, \ref{sect:ND_time_disct_adv_diff}. This is selected by setting:
\begin{itemize}
\item \option{\ldots/temporal\_discretisation/theta} to 0.5
\item \option{\ldots/temporal\_discretisation/relaxation} to 0.5
\end{itemize}

If using P1-P1, the following are recommended for the spatial discretisation:
\begin{itemize}
\item \option{\ldots/spatial\_discretisation/continuous\_galerkin/stabilisation/no\_stabilisation}, cf. \ref{Sect:ND_advective_stabilisation_CG}
\item \option{\ldots/spatial\_discretisation/continuous\_galerkin/mass\_terms/lump\_mass\_matrix}, cf. \ref{Sect:ND_cg_mass_lumping}
\item \option{\ldots/spatial\_discretisation/conservative\_advection} set to 0 (non-conservative), \ref{Sect:Spatial discretisations}
\end{itemize}

If using P1DG-P2, the following are recommended for the spatial discretisation:
\begin{itemize}
\item \option{\ldots/spatial\_discretisation/discontinuous\_galerkin/viscosity\_scheme/compact\_discontinuous\_galerkin}, cf. \ref{sec:NM_DG_diffusion}
\item \option{\ldots/spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/upwind}, cf. \ref{Sect:ND_discontinuous_galerkin_advection}
\item \option{\ldots/spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/integrate\_advection\_by\_parts/twice}, cf. \ref{Sect:ND_discontinuous_galerkin_advection}
\item \option{\ldots/spatial\_discretisation/conservative\_advection} set to 0 (non-conservative), \ref{Sect:Spatial discretisations}
\end{itemize}

\subsubsection{Advected scalar fields}
The recommended options for scalar fields are considered for P1-P1 and P1DG-P2 separately. \\ \\
{\bf \Poo} \\ \\
The mesh used should be the \option{CoordinateMesh} and the equation type \option{AdvectionDiffusion}, cf. \ref{Sect:ND_advection_diffusion_discretisation}. 

For the spatial discretisation a control-volumes discretisation with a finite-element face value discretisation and Sweby limiter are recommended which are selected with the options, cf. \ref{Sect:CVs}:
\begin{itemize}
\item \option{\ldots/spatial\_discretisation/control\_volumes/face\_value::FiniteElement}
\item \option{\ldots/prognostic/spatial\_discretisation/control\_volumes/face\_value::FiniteElement/limit\_face\_value/limiter::Sweby}
\end{itemize}
To help increase speed it is possible to store upwind elements so they do not have to be recalculated every time step (only after adapts). To do this activate the option:
\begin{itemize}
\item{\option{\ldots/prognostic/spatial\_discretisation/control\_volumes/face\_value::FiniteElement/limit\_face\_value/limiter::Sweby/project\_upwind\_value\_from\_point/store\_upwind\_elements}}
\end{itemize}
An Element Gradient diffusion scheme is also generally recommended, selected under \option{\ldots/spatial\_discretisation/control\_volumes/diffusion\_scheme::ElementGradient}

For the temporal discretisation a Crank-Nicolson scheme is recommended, with the control volume options of 3 advection iterations and limit theta, cf. \ref{Sect:CVs}. These are set with the options:
\begin{itemize}
\item{\option{\ldots/temporal\_discretisation/theta} set to 0.5}
\item{\option{\ldots/temporal\_discretisation/control\_volumes/number\_advection\_iterations}}
\item{\option{\ldots/prognostic/temporal\_discretisation/control\_volumes/limit\_theta}}
\end{itemize}

{\bf \PoDGPt} \\

The mesh used should be the \option{VelocityMesh} and the equation type \option{AdvectionDiffusion}, cf. \ref{Sect:ND_advection_diffusion_discretisation}. 

For the spatial discretisation a discontiuous-Galerkin discretisation
is recommended with a Lax-Friedrichs advection scheme, velocity
projected to continuous space, advection integrated by parts once and
a compact-discontinuous-Galerkin diffusion scheme with a vertex-based
slope limiter. These options are selected with:
\begin{itemize}
\item{\option{\ldots/spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/lax\_friedrichs}, cf. \ref{Sect:ND_discontinuous_galerkin_advection}}
\item{\option{\ldots/spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/project\_velocity\_to\_continuous/mesh::CoordinateMesh}}
\item{\option{\ldots/spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/integrate\_advection\_by\_parts/once}, cf. \ref{Sect:ND_discontinuous_galerkin_advection}}
\item{\option{\ldots/spatial\_discretisation/discontinuous\_galerkin/diffusion\_scheme/compact\_discontinuous\_galerkin}, cf. \ref{sec:NM_DG_diffusion}}
\item{\option{\ldots/spatial\_discretisation/discontinuous\_galerkin/slope\_limiter::Vertex\_Based}, cf. \ref{Sect:ND_DG_slope_limiters}.}
\end{itemize}

For the temporal discretisation a Crank-Nicolson scheme with subcycling is recommended. This can be set with:
\begin{itemize}
\item{\option{\ldots/temporal\_discretisation/theta} set to 0.5}
\item{\option{\ldots/temporal\_discretisation/discontinuous\_galerkin/maximum\_courant\_number\_per\_subcycle} set to an appropriate value.}
\end{itemize}


\subsubsection{Geostrophic Pressure}
\label{Sect:GFD_config_geopressure}
If enabled a `geopressure' solver is used, \ref{Sect:config_geostrophic_balance}. 
\begin{itemize}
\item The specified mesh should be the \option{GeostrophicPressureMesh}, cf. \ref{sect:GFD_config_geometry}. 
\item The terms included in the right-hand side of the geopressure solver are selected under: \\
\option{\ldots/spatial\_discretisation/geostrophic\_pressure\_option}.
\item A reference node must be set as geopressure uses Neumann boundary conditions on all boundaries (cf. \ref{Nullspaceremove}), for example:
\option{\ldots/reference\_node::node\_1}
\end{itemize}

\section{Mesh adaptivity} \label{sec:config_adapt}

The configuration on mesh adaptivity occurs in two places: under \option{mesh\_adaptivity} where 
the overall adaptive settings are configured, and on a per-field basis where both the interpolation
method is set and if that field should be considered when creating the error metric. See chapter 
\ref{chap:Adaptivity} for information on how the metric is formed.

\subsection{Field settings}

For each field present in the simulation there are up to two options that should be set. The first
is the interpolation method that should be used to transfer the values of a field from the old to the new mesh.
Second, in order to form the error metic by which the mesh is adapted, the user must set which fields
should form the error metric and how the error for that field should be calculated.

\subsubsection{Interpolation method} \label{sec:config_adapt_interp}

For each prognostic field in the current state, an interpolation type must be set. These can be set by selecting an
option \option{\ldots/prognostic/<interpolation type>} where \texttt{<interpolation type>} is one of:
\begin{itemize}
\item Consistent interpolation - the default and quick inteprolation method, but is non-conservative and dissipative.
\item Pseudo-consistent interpolation - not recommended at present.
\item Galerkin interpolation - Conservative and non-dissipative, but requires the construction of a supermesh \citep{farrell2009a,farrell2010a}
\item Grandy interpolation - Conservative, but highly diffusive. See \citet{grandy1999}.
\end{itemize}

For some fields, such as Pressure and Velocity other interpolation methods are available.

For diagnostic and prescribed fields an inteprolation method is not required. However, if an output dump
occurs immeadiately following a mesh adapt, diagnostic fields may not have correct values depending
on the method by which they are calculated. In these instances, it is worth setting an interpolation type
for these fields which will ensure that the values are set correctly before an output dump occurs.

The Galerkin projection also requires some further settings depending on the mesh type. For discontinuous
meshes there are no other required settings.  For continuous meshes a solver is required in order
to perform the supermesh projection. The solver settings are configured as with any other solver, see
section \ref{Sect:Solve} for more details.

With piecewise linear continuous fields additional options are available to bound the result following a Galerkin projection:\\
\option{\ldots/galerkin\_projection/continuous/bounded::Diffuse}\\
and\\
\option{\ldots/galerkin\_projection/continuous/bounded::Algencan}\\
The latter uses the algencan optimisation library to bound the field and requires \fluidity\ to be configured with \lstinline[language=bash]+--enable-algencan+.  The \option{Diffuse} bounding algorithm is internal to \fluidity\ and the most frequently used.

To use the \option{Diffuse} bounding algorithm \citep{farrell2009a} the number of iterations the algorithm is allowed to take must be specified.  Additionally an optional tolerance can be specified to terminate this iteration loop early.  Furthermore if the bounds on the field are known in advance then these can be specified through:\\
\option{\ldots/bounded::Diffuse/bounds/upper\_bound}\\
and\\
\option{\ldots/bounded::Diffuse/bounds/lower\_bound}.\\
If the diffusion bounding algorithm fails to locally redistribute the unboundedness then a conservative but non-local redistribution can be activated using:\\
\option{\ldots/bounded::Diffuse/repair\_deviations}\\
again with an optional tolerance:\\
\option{\ldots/bounded::Diffuse/repair\_deviations/tolerance}.

\subsubsection{Creating an error metric}
\label{sect:configuring_fluidity_error_metric}

The second step for configuring adaptivity is to set up the fields that are to form the error metric used
to adapt the mesh. For each field that should be considered when forming the metric the option
\option{\ldots/adaptivity\_options} needs to be enabled. The error bound is set as seperate fields within 
state, so for Temperature, for example, the acceptable error is stored an a field called 
TemperatureInterpolationErrorBound. There are two methods available for calculating the error, absolute and relative.
Both have similar options in which the InterpolationErrorBound field can be set as with any other prescribed field.
One can, for example, set a different error metric in different regions on the mesh. This field
is output as any other field too.

For relative interpolation error bounds a tolerance value also has to be set under \newline
\option{\ldots/adaptivity\_options/relative\_measure/tolerance}. This value prevents division by zero
and should be set to a small enough number that the field can effecivtly be considered zero at this value.

\subsection{General adaptivity options}
\label{sect:configuring_fluidity_adaptivity_options}
\index{adaptivity options}

These are found under \option{mesh\_adaptivity}. Here the user can specify whether to use mesh movement methods, 
prescribed adaptivity (serial only) or hr adaptivity. hr adaptivity is the normal method for most applications.

Under \option{/mesh\_adaptivity/hr\_adaptivity} there are a number of mandatory options, which are:
\begin{itemize}
\item period - how often should the mesh be adapted. This can be set in number of simulation seconds, 
or in number of timesteps. It is recommended that adapt happen every 10-20 timesteps.
\item maximum number of nodes - sets the maximum possible number of nodes in the domain. In parallel this is the
global maximum number, but can be altered to be the number per process.
\item enable gradation - is on by default and set to a value of 1.5. 
\item minimum edge lengths - a tensor specifying the minimum edge length of an element.
\item maximum edge lengths - a tensor specifying the maximum edge length of an element.
\end{itemize}

In addition to these mandatory settings, there are a number of other configuration options.

\subsubsection{Metric advection}
\label{sect:configuring_fluidity_metric_advection}



\section{Multiple material/phase models} \label{sec:config_multimatph}

This section contains advice on setting up simulations with multiple material\_phase options.  This enables related fields to be grouped together into related materials or phases.  For example a prognostic scalar field in one material\_phase will be advected using the Velocity from that material\_phase while a prognostic scalar field in another material\_phase will be advected according to the Velocity in its material\_phase.

We refer to two typical scenarios: a \emph{multiple material} model and a \emph{multiple phase} model. A multiple phase model is one in which the Velocity field in each material\_phase is in some way independent of the velocities in the other material\_phases.  This means that scalar fields (for example phase volume fractions) in each material\_phase are advected independently.  A multiple material model is one in which the Velocity field is shared between all material\_phases so that all scalar fields are advected similarly.

\subsection{Multiple material models}

Models with a single prognostic velocity field that is shared between material\_phases (using the \option{aliased} field type) are referred to as multiple material models.  These are generally used to describe systems of nearly immiscible materials with different material properties contained within the same domain.  This section focusses on this type of multiple material\_phase simulation.

In a multiple material simulation each material\_phase requires:
\begin{itemize}
\item an equation of state
\item a MaterialVolumeFraction scalar field
\end{itemize}

The equation of state provides the density properties of the material described in the current material\_phase.  For incompressible simulations a linear equation of state is used, which only requires a reference density:\\
\option{\ldots/equation\_of\_state/fluids/linear/reference\_density}\\
to be set.  For Boussinesq multimaterial simulations, where a material's density depends on temperature and/or salinity, then the same dependencies exist between the equation of state and these fields as in single material simulations.  For example a Temperature field must be present in the material\_phase where it is needed (although it may be aliased between material\_phases).  If the \option{subtract\_out\_hydrostatic\_level} option is selected, it must only be select in a single material\_phase.  Fully compressible multimaterial simulations are not supported.

The MaterialVolumeFraction field describes the location of the material, varying from $1$ in regions where the cells are entirely the current material to $0$ where none of this material is present.  As the materials are generally treated as being nearly immiscible, the prognostic MaterialVolumeFraction field should be discretised using a control volume spatial discretisation with one of the face value schemes designed for advecting step functions:
\begin{itemize}
\item \option{\ldots/spatial\_discretisation/control\_volumes/face\_value::HyperC}
\item \option{\ldots/spatial\_discretisation/control\_volumes/face\_value::UltraC}
\item \option{\ldots/spatial\_discretisation/control\_volumes/face\_value::PotentialUltraC}
\end{itemize}
as described in sections \ref{sec:hyperc}--\ref{sec:potultrac}.  These schemes are only guaranteed to be bounded for explicit advection so the implicitness factor, $\theta$:\\
\option{\ldots/temporal\_discretisation/theta}\\
and the pivot implicitness factor, $\theta_p$:\\
\option{\ldots/temporal\_discretisation/control\_volumes/pivot\_theta}\\
should be set to zero and, for high Courant number flows, advection subcycling should be used:\\
\option{\ldots/temporal\_discretisation/control\_volumes/maximum\_courant\_number\_per\_subcycle}\\
or\\
\option{\ldots/temporal\_discretisation/control\_volumes/number\_advection\_subcycles}.

For an $N$ material problem, $N$ material\_phases are required and hence $N$ MaterialVolumeFractions, $c^i, i =1, \ldots, N$, and $N$ equations of state.  However, only $N-1$ of the MaterialVolumeFraction fields, $c^i, i =1, \ldots, N-1$, need be prognostic.  The final volume fraction field, $c^N$, should always be set to \option{diagnostic}, as it can be recovered using the internal algorithm:
\begin{equation} \label{eq:config_diagvfrac}
c^N = 1 - \sum_{i=1}^{N-1}c^i\textrm{.}
\end{equation}
So, for example, in the case when $N=2$ there need only be a single prognostic MaterialVolumeFraction field and a single diagnostic MaterialVolumeFraction field.  In this case it makes no difference which material\_phase contains the prognostic volume fraction and which contains the diagnostic field.  In more complicated scenarios with $N>2$ a coupled control volume discretisation (see section \ref{sec:coupledlimiter}) becomes necessary to ensure that not only each of the $N-1$ prognostic MaterialVolumeFractions remain bounded but also that their sum, $\sum_{i=1}^{N-1}c^i$, is bounded.  This ensures, through equation \ref{eq:config_diagvfrac}, that the final diagnostic MaterialVolumeFraction is also bounded.  As discussed in section \ref{sec:coupledlimiter} this process requires a priority ordering for the fields, which must be specified at:\\
\option{\ldots/scalar\_field::MaterialVolumeFraction/prognostic/priority}.\\
The diagnostic field is always treated as the lowest priority volume fraction so in this case the choice of priority ordering and diagnostic field may affect the results if the interfaces between the materials are in the vicinity of one another.  Priority ordering and coupled limiting do not affect the advection process if the material interfaces are separated from each other.

If adaptive remeshing is being used then the bounded and minimally dissipative behaviour of the above advection must be preserved through the interpolation between successive meshes.  As discussed in section \ref{sec:config_adapt} several interpolation algorithms are available.  We discuss them again here in terms of their suitability for multiple material modelling.  Consistent interpolation on piecewise linear parent meshes guarantees boundedness of the interpolated volume fraction field and of the sum of the volume fractions.  However it tends to introduce excessive amounts of numerical diffusion and it is not conservative.  Galerkin projection guarantees conservation of the field and is not excessively dissipative.  However it does not guarantee boundedness.

To ensure minimal dissipation, conservation and boundedness it is necessary to use a bounding algorithm following the Galerkin projection.  The \option{Diffuse} bounding algorithm (see section \ref{sec:config_adapt_interp}) is generally used.  This redistributes unbounded values in the field locally, guaranteeing boundedness of each volume fraction individually.  It does not however guarantee boundedness of the sum of the volume fractions and this must be enforced by coupling each MaterialVolumeFraction field together through the interpolation with the option:\\
\option{\ldots/bounded::Diffuse/bounds/upper\_bound/coupled}\\
under all $N-1$ prognostic MaterialVolumeFractions.  As with coupled control volume advection this uses the priority numbering of the fields to determine the order in which they are bounded.  The local bounds enforced on successive fields are then modified to ensure boundedness of their sum.  This redistribution of materials during the bounding procedure introduces some relative movement between materials, which, by equation \ref{eq:config_diagvfrac}, is filled in by the diagnostic MaterialVolumeFraction.  Despite this problem bounded Galerkin projection is recommended to transfer field data during mesh adaptivity.

The advected (and interpolated) volume fractions describe volume averaged the locations of the materials.  In combination with the equation of state they can therefore be used to define global bulk values for the density using:
\begin{equation}
\rho = \sum_{i=1}^N\rho^ic^i
\end{equation}
where $\rho$ is the bulk density and $\rho^i$ are the individual material densities, given by their respective equations of state.  This bulk density can be seen in the diagnostic Density field in whichever material\_phase has the prognostic Velocity field in it.

In addition to the density the volume fractions may be used to specify a bulk Viscosity that varies between the materials according to:
\begin{equation}
\tensor{\mu} = \sum_{i=1}^N\tensor{\mu}^ic^i
\end{equation}
where $\tensor{\mu}$ is the bulk viscosity and $\tensor{\mu}^i$ is the individual material's viscosity.  To use this it is necessary to activate a MaterialViscosity field in every material\_phase with a nonzero viscosity.  Additionally the Viscosity field underneath the prognostic Velocity must be activated and set to the \option{bulk\_viscosity} diagnostic algorithm.

\subsection{Multiple phase models}
Models with one prognostic velocity field per \option{material\_phase} are referred to as multiple phase models. The use of these multiple velocity fields permits the inter-penetration and interaction between different phases.

\subsubsection{Simulation requirements}
In a multi-phase simulation, each \option{material\_phase} requires:
\begin{itemize}
 \item an equation of state
 \item a PhaseVolumeFraction scalar field
\end{itemize}

As per multi-material simulations, the equation of state provides the density properties of the phase described in the current \option{material\_phase}. For incompressible simulations a linear equation of state is used, which only requires a reference density:\\
\option{\ldots/equation\_of\_state/fluids/linear/reference\_density}\\
to be set.

For an $N$ phase problem, $N$ material\_phases are required and hence $N$ PhaseVolumeFractions, $\alpha_i, i = 1, \ldots, N$, and $N$ equations of state. Just like multi-material simulations, only $N-1$ of the PhaseVolumeFraction fields, $\alpha_i, i = 1, \ldots, N-1$, need be prognostic. The final PhaseVolumeFraction field, $\alpha_N$, should always be set to \option{diagnostic}, as it can be recovered using the internal algorithm:
\begin{equation}
\alpha_N = 1 - \sum_{i=1}^{N-1}\alpha_i\textrm{.}
\end{equation}

\subsubsection{Inter-phase interactions}
Inter-phase interactions can be included under \option{../multiphase\_properties} in Diamond. Currently, \fluidity\ only supports fluid-particle drag between the continuous phase and dispersed phase(s), given by:
\begin{equation}\label{eq:multiphase_drag_term}
\mathbf{F}_D = \frac{3\ \alpha_p\ C_D\ \alpha_f\ \rho_f\ |\mathbf{u}_f-\mathbf{u}_p|\ (\mathbf{u}_f-\mathbf{u}_p)}{4\ d}
\end{equation}
where $f$ and $p$ denote the fluid and particle phases respectively. The drag coefficient $C_D$ is:
\begin{equation}\label{eq:wen_yu_drag_coefficient}
C_D = \frac{24}{\mathrm{Re}}
\end{equation}
with
\begin{equation}\label{eq:particle_reynolds_number}
\mathrm{Re} = \frac{\alpha_f\ \rho_f\ d\ |\mathbf{u}_f-\mathbf{u}_p|}{\mu_f}
\end{equation}

Adding a \option{particle\_diameter} to a dispersed phase enables fluid-particle interaction between itself and the continuous phase.

\subsubsection{Current limitations}
\begin{itemize}
 \item Boussinesq and fully compressible multi-phase simulations are not yet supported.
 \item The momentum equation for each \option{material\_phase} can only be discretised in non-conservative form.
 \item The \option{arbitrary\_upwind} and \option{interior\_penalty} viscosity schemes for DG do not yet support multiple phases.
 \item Discontinuous \option{PhaseVolumeFraction} fields are not yet supported.
 \item The Pressure field only supports a continuous Galerkin discretisation.
 \item Prescribed velocity fields cannot yet be used in multi-phase simulations.
 \item Fluid-particle drag can currently only support one continuous (i.e. fluid) phase.
\end{itemize}


\section{Compressible fluid model}
\index{compressible fluid model}

Enabling \option{\ldots/material\_phase/equation\_of\_state/compressible} allows the compressible equations described in sections 
\ref{Sect:compressible_conservative} and \ref{Sect:compressible_nonconservative} to be solved. At the moment there is one available option for the required 
compressible equation of state: Mie-Grunneisen (see section \ref{Sect:Multi-material compressible EOS}).  Compressible functionality is not yet fully supported and this is intended as a stub upon which further developments will be described.

This section contains advice for running a compressible simulation, by describing the necessary options to set up the problem. The options required for prognostic fields are:

\subsection{Pressure options}
\begin{itemize}
\item The value for the atmospheric pressure can be added by switching on \option{\ldots/atmospheric\_pressure}, otherwise a default of zero is used.
\item A Poisson pressure equation should not be used to calculate a first guess, therefore \\* \option{\ldots/scheme/poisson\_pressure\_solution} should be set to $never$.
\item \option{\ldots/scheme/use\_compressible\_projection\_method} shuold be selected, so the calculated pressure satisfies the continuity equation and the EOS.
\end{itemize}

\subsection{Density options}
\option{\ldots/prognostic/equation} and \option{\ldots/prognostic/solver} do not need to be enabled. If the equation type is not turned on, the density will make 
use of the pressure solve, so no solver options are needed either. By having an equation type turned on, the density is not only incorporated into the pressure solve 
but also an Advection-Diffusion equation is solved (and solver options need to be specified).

\subsection{Velocity options}
\begin{itemize}
\item for continuous velocities \option{\ldots/spatial\_discretisation/\ldots/lump\_mass\_matrix} should be turned on.
\item in the presence of viscosity \option{\ldots/spatial\_discretisation/continuous\_galerkin/stress\_terms/stress\_form} is required and all components of the anisotropic symmetric Viscosity tensor should be filled out.  This functionality is only available with continuous Galerkin velocities.
\end{itemize}

\subsection{Restrictions: discretisation options and element pairs}
Either continuous Galerkin or control volumes can be used as discretisation options for pressure and density (both fields need to have the same option). When using control volumes pressure and density have to be on the same order of parent mesh.

